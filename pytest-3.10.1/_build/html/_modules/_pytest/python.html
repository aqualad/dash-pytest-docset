
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>_pytest.python &#8212; pytest documentation</title>
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/pytest1favi.ico"/>
    <link rel="search" title="Search" href="../../search.html" />
  </head><body>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../../contents.html">pytest-3.10</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">

  <h1>Source code for _pytest.python</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; Python test discovery, setup and run of test functions. &quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>

<span class="kn">import</span> <span class="nn">py</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">import</span> <span class="nn">_pytest</span>
<span class="kn">from</span> <span class="nn">_pytest</span> <span class="kn">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">_pytest</span> <span class="kn">import</span> <span class="n">fixtures</span>
<span class="kn">from</span> <span class="nn">_pytest</span> <span class="kn">import</span> <span class="n">nodes</span>
<span class="kn">from</span> <span class="nn">_pytest._code</span> <span class="kn">import</span> <span class="n">filter_traceback</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">ascii_escaped</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">enum</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">get_default_arg_names</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">get_real_func</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">getfslineno</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">getimfunc</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">getlocation</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">is_generator</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">isclass</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">isfunction</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">NoneType</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">NOTSET</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">REGEX_TYPE</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">safe_getattr</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">safe_isclass</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">safe_str</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">STRING_TYPES</span>
<span class="kn">from</span> <span class="nn">_pytest.config</span> <span class="kn">import</span> <span class="n">hookimpl</span>
<span class="kn">from</span> <span class="nn">_pytest.main</span> <span class="kn">import</span> <span class="n">FSHookProxy</span>
<span class="kn">from</span> <span class="nn">_pytest.mark.structures</span> <span class="kn">import</span> <span class="n">get_unpacked_marks</span>
<span class="kn">from</span> <span class="nn">_pytest.mark.structures</span> <span class="kn">import</span> <span class="n">normalize_mark_list</span>
<span class="kn">from</span> <span class="nn">_pytest.mark.structures</span> <span class="kn">import</span> <span class="n">transfer_markers</span>
<span class="kn">from</span> <span class="nn">_pytest.outcomes</span> <span class="kn">import</span> <span class="n">fail</span>
<span class="kn">from</span> <span class="nn">_pytest.pathlib</span> <span class="kn">import</span> <span class="n">parts</span>
<span class="kn">from</span> <span class="nn">_pytest.warning_types</span> <span class="kn">import</span> <span class="n">PytestWarning</span>
<span class="kn">from</span> <span class="nn">_pytest.warning_types</span> <span class="kn">import</span> <span class="n">RemovedInPytest4Warning</span>


<span class="k">def</span> <span class="nf">pyobj_property</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s2">&quot;pytest&quot;</span><span class="p">),</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span>

    <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;python </span><span class="si">%s</span><span class="s2"> object this node was collected from (can be None).&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getgroup</span><span class="p">(</span><span class="s2">&quot;general&quot;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--fixtures&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--funcargs&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;showfixtures&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show available fixtures, sorted by plugin appearance &quot;</span>
        <span class="s2">&quot;(fixtures with leading &#39;_&#39; are only shown with &#39;-v&#39;)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--fixtures-per-test&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;show_fixtures_per_test&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show fixtures per test&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
        <span class="s2">&quot;usefixtures&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;list of default fixtures to be used with this project&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
        <span class="s2">&quot;python_files&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;test_*.py&quot;</span><span class="p">,</span> <span class="s2">&quot;*_test.py&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;glob-style file patterns for Python test module discovery&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
        <span class="s2">&quot;python_classes&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Test&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;prefixes or glob names for Python test class discovery&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
        <span class="s2">&quot;python_functions&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;prefixes or glob names for Python test function and method discovery&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--import-mode&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;prepend&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;prepend&quot;</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">],</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;importmode&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;prepend/append to sys.path when importing test modules, &quot;</span>
        <span class="s2">&quot;default is to prepend.&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_cmdline_main</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">showfixtures</span><span class="p">:</span>
        <span class="n">showfixtures</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">show_fixtures_per_test</span><span class="p">:</span>
        <span class="n">show_fixtures_per_test</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">pytest_generate_tests</span><span class="p">(</span><span class="n">metafunc</span><span class="p">):</span>
    <span class="c1"># those alternative spellings are common - raise a specific error to alert</span>
    <span class="c1"># the user</span>
    <span class="n">alt_spellings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;parameterize&quot;</span><span class="p">,</span> <span class="s2">&quot;parametrise&quot;</span><span class="p">,</span> <span class="s2">&quot;parameterise&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">alt_spellings</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">metafunc</span><span class="o">.</span><span class="n">function</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> has &#39;</span><span class="si">{1}</span><span class="s2">&#39; mark, spelling should be &#39;parametrize&#39;&quot;</span>
            <span class="n">fail</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metafunc</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">iter_markers</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;parametrize&quot;</span><span class="p">):</span>
        <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="o">*</span><span class="n">marker</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">marker</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_configure</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span>
        <span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parametrize(argnames, argvalues): call a test function multiple &quot;</span>
        <span class="s2">&quot;times passing in different arguments in turn. argvalues generally &quot;</span>
        <span class="s2">&quot;needs to be a list of values if argnames specifies only one name &quot;</span>
        <span class="s2">&quot;or a list of tuples of values if argnames specifies multiple names. &quot;</span>
        <span class="s2">&quot;Example: @parametrize(&#39;arg1&#39;, [1,2]) would lead to two calls of the &quot;</span>
        <span class="s2">&quot;decorated test function, one with arg1=1 and another with arg1=2.&quot;</span>
        <span class="s2">&quot;see https://docs.pytest.org/en/latest/parametrize.html for more info &quot;</span>
        <span class="s2">&quot;and examples.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span>
        <span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;usefixtures(fixturename1, fixturename2, ...): mark tests as needing &quot;</span>
        <span class="s2">&quot;all of the specified fixtures. see &quot;</span>
        <span class="s2">&quot;https://docs.pytest.org/en/latest/fixture.html#usefixtures &quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@hookimpl</span><span class="p">(</span><span class="n">trylast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_pyfunc_call</span><span class="p">(</span><span class="n">pyfuncitem</span><span class="p">):</span>
    <span class="n">testfunction</span> <span class="o">=</span> <span class="n">pyfuncitem</span><span class="o">.</span><span class="n">obj</span>
    <span class="k">if</span> <span class="n">pyfuncitem</span><span class="o">.</span><span class="n">_isyieldedfunction</span><span class="p">():</span>
        <span class="n">testfunction</span><span class="p">(</span><span class="o">*</span><span class="n">pyfuncitem</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">funcargs</span> <span class="o">=</span> <span class="n">pyfuncitem</span><span class="o">.</span><span class="n">funcargs</span>
        <span class="n">testargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">pyfuncitem</span><span class="o">.</span><span class="n">_fixtureinfo</span><span class="o">.</span><span class="n">argnames</span><span class="p">:</span>
            <span class="n">testargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">funcargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
        <span class="n">testfunction</span><span class="p">(</span><span class="o">**</span><span class="n">testargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">pytest_collect_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">ext</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.py&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">isinitpath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path_matches_patterns</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="s2">&quot;python_files&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;__init__.py&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">return</span>
        <span class="n">ihook</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">gethookproxy</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_pycollect_makemodule</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">path_matches_patterns</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">patterns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True if the given py.path.local matches one of the patterns in the list of globs given&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_pycollect_makemodule</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Package</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Module</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>


<span class="nd">@hookimpl</span><span class="p">(</span><span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_pycollect_makeitem</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">outcome</span> <span class="o">=</span> <span class="k">yield</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">outcome</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># nothing was collected elsewhere, let&#39;s do it here</span>
    <span class="k">if</span> <span class="n">safe_isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">collector</span><span class="o">.</span><span class="n">istestclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">Class</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">_getcustomclass</span><span class="p">(</span><span class="s2">&quot;Class&quot;</span><span class="p">)</span>
            <span class="n">outcome</span><span class="o">.</span><span class="n">force_result</span><span class="p">(</span><span class="n">Class</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">collector</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">collector</span><span class="o">.</span><span class="n">istestfunction</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># mock seems to store unbound methods (issue473), normalize it</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__func__&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="c1"># We need to try and unwrap the function if it&#39;s a functools.partial</span>
        <span class="c1"># or a funtools.wrapped.</span>
        <span class="c1"># We musn&#39;t if it&#39;s been wrapped with mock.patch (python 2 only)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">isfunction</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isfunction</span><span class="p">(</span><span class="n">get_real_func</span><span class="p">(</span><span class="n">obj</span><span class="p">))):</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">getfslineno</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn_explicit</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="n">PytestWarning</span><span class="p">(</span>
                    <span class="s2">&quot;cannot collect </span><span class="si">%r</span><span class="s2"> because it is not a function.&quot;</span> <span class="o">%</span> <span class="n">name</span>
                <span class="p">),</span>
                <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__test__&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_generator</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">Generator</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">collector</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">collector</span><span class="o">.</span><span class="n">_genfunctions</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
            <span class="n">outcome</span><span class="o">.</span><span class="n">force_result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_make_parametrize_id</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">argname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">PyobjContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">pyobj_property</span><span class="p">(</span><span class="s2">&quot;Module&quot;</span><span class="p">)</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">pyobj_property</span><span class="p">(</span><span class="s2">&quot;Class&quot;</span><span class="p">)</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">pyobj_property</span><span class="p">(</span><span class="s2">&quot;Instance&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PyobjMixin</span><span class="p">(</span><span class="n">PyobjContext</span><span class="p">):</span>
    <span class="n">_ALLOW_MARKERS</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PyobjMixin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">obj</span><span class="p">():</span>
        <span class="k">def</span> <span class="nf">fget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_obj&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getobj</span><span class="p">()</span>
                <span class="c1"># XXX evil hack</span>
                <span class="c1"># used to avoid Instance collector marker duplication</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ALLOW_MARKERS</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">own_markers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_unpacked_marks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">obj</span>

        <span class="k">def</span> <span class="nf">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">fget</span><span class="p">,</span> <span class="n">fset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;underlying python object&quot;</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getmodpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stopatmodule</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">includemodule</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return python path relative to the containing module. &quot;&quot;&quot;</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listchain</span><span class="p">()</span>
        <span class="n">chain</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Instance</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Module</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">stopatmodule</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">includemodule</span><span class="p">:</span>
                        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.[&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getfslineno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">getfslineno</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reportinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># XXX caching?</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span>
        <span class="n">compat_co_firstlineno</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;compat_co_firstlineno&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compat_co_firstlineno</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># nose compatibility</span>
            <span class="n">fspath</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span><span class="o">.</span><span class="vm">__file__</span>
            <span class="k">if</span> <span class="n">fspath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pyc&quot;</span><span class="p">):</span>
                <span class="n">fspath</span> <span class="o">=</span> <span class="n">fspath</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">compat_co_firstlineno</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fspath</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">getfslineno</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">modpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmodpath</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fspath</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">modpath</span>


<span class="k">class</span> <span class="nc">PyCollector</span><span class="p">(</span><span class="n">PyobjMixin</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">funcnamefilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matches_prefix_or_glob_option</span><span class="p">(</span><span class="s2">&quot;python_functions&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">isnosetest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Look for the __test__ attribute, which is applied by the</span>
<span class="sd">        @nose.tools.istest decorator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We explicitly check for &quot;is True&quot; here to not mistakenly treat</span>
        <span class="c1"># classes with a custom __getattr__ returning something truthy (like a</span>
        <span class="c1"># function) as test classes.</span>
        <span class="k">return</span> <span class="n">safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__test__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">classnamefilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matches_prefix_or_glob_option</span><span class="p">(</span><span class="s2">&quot;python_classes&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">istestfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcnamefilter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isnosetest</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">):</span>
                <span class="c1"># static methods need to be unwrapped</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__func__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">getfixturemarker</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">istestclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">classnamefilter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isnosetest</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_matches_prefix_or_glob_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_name</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        checks if the given name matches the prefix or glob-pattern defined</span>
<span class="sd">        in ini configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="n">option_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">option</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># check that name looks like a glob-string before calling fnmatch</span>
            <span class="c1"># because this is called for every name in each collected module,</span>
            <span class="c1"># and fnmatch is somewhat expensive to call</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">option</span> <span class="ow">or</span> <span class="s2">&quot;?&quot;</span> <span class="ow">in</span> <span class="n">option</span> <span class="ow">or</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">option</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__test__&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># NB. we avoid random getattrs and peek in the __dict__ instead</span>
        <span class="c1"># (XXX originally introduced from a PyPy need, still true?)</span>
        <span class="n">dicts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">,</span> <span class="p">{})]</span>
        <span class="k">for</span> <span class="n">basecls</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="n">dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basecls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dic</span> <span class="ow">in</span> <span class="n">dicts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">seen</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeitem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>
                <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">reportinfo</span><span class="p">()[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">makeitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">deprecated</span><span class="o">.</span><span class="n">COLLECTOR_MAKEITEM</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_makeitem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_makeitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># assert self.ihook.fspath == self.fspath, self</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ihook</span><span class="o">.</span><span class="n">pytest_pycollect_makeitem</span><span class="p">(</span><span class="n">collector</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_genfunctions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">funcobj</span><span class="p">):</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">Module</span><span class="p">)</span><span class="o">.</span><span class="n">obj</span>
        <span class="n">clscol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">Class</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">clscol</span> <span class="ow">and</span> <span class="n">clscol</span><span class="o">.</span><span class="n">obj</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">transfer_markers</span><span class="p">(</span><span class="n">funcobj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="n">FunctionDefinition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">callobj</span><span class="o">=</span><span class="n">funcobj</span><span class="p">)</span>
        <span class="n">fixtureinfo</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getfixtureinfo</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">funcobj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>

        <span class="n">metafunc</span> <span class="o">=</span> <span class="n">Metafunc</span><span class="p">(</span>
            <span class="n">definition</span><span class="p">,</span> <span class="n">fixtureinfo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">module</span>
        <span class="p">)</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;pytest_generate_tests&quot;</span><span class="p">):</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">pytest_generate_tests</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;pytest_generate_tests&quot;</span><span class="p">):</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">pytest_generate_tests</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">methods</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ihook</span><span class="o">.</span><span class="n">pytest_generate_tests</span><span class="o">.</span><span class="n">call_extra</span><span class="p">(</span>
                <span class="n">methods</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">metafunc</span><span class="o">=</span><span class="n">metafunc</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ihook</span><span class="o">.</span><span class="n">pytest_generate_tests</span><span class="p">(</span><span class="n">metafunc</span><span class="o">=</span><span class="n">metafunc</span><span class="p">)</span>

        <span class="n">Function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getcustomclass</span><span class="p">(</span><span class="s2">&quot;Function&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">fixtureinfo</span><span class="o">=</span><span class="n">fixtureinfo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># add funcargs() as fixturedefs to fixtureinfo.arg2fixturedefs</span>
            <span class="n">fixtures</span><span class="o">.</span><span class="n">add_funcarg_pseudo_fixture_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metafunc</span><span class="p">,</span> <span class="n">fm</span><span class="p">)</span>

            <span class="c1"># add_funcarg_pseudo_fixture_def may have shadowed some fixtures</span>
            <span class="c1"># with direct parametrization, so make sure we update what the</span>
            <span class="c1"># function really needs.</span>
            <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">prune_dependency_tree</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">callspec</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span>
                <span class="n">subname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">callspec</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">Function</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">subname</span><span class="p">,</span>
                    <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">callspec</span><span class="o">=</span><span class="n">callspec</span><span class="p">,</span>
                    <span class="n">callobj</span><span class="o">=</span><span class="n">funcobj</span><span class="p">,</span>
                    <span class="n">fixtureinfo</span><span class="o">=</span><span class="n">fixtureinfo</span><span class="p">,</span>
                    <span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="n">callspec</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                    <span class="n">originalname</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>


<div class="viewcode-block" id="Module"><a class="viewcode-back" href="../../reference.html#_pytest.python.Module">[docs]</a><span class="k">class</span> <span class="nc">Module</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="n">PyCollector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Collector for test classes and functions. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_getobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_importtestmodule</span><span class="p">()</span>

<div class="viewcode-block" id="Module.collect"><a class="viewcode-back" href="../../reference.html#_pytest.python.Module.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">parsefactories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Module</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_importtestmodule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># we assume we are only called once per module</span>
        <span class="n">importmode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;--import-mode&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspath</span><span class="o">.</span><span class="n">pyimport</span><span class="p">(</span><span class="n">ensuresyspath</span><span class="o">=</span><span class="n">importmode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectError</span><span class="p">(</span>
                <span class="n">_pytest</span><span class="o">.</span><span class="n">_code</span><span class="o">.</span><span class="n">ExceptionInfo</span><span class="p">()</span><span class="o">.</span><span class="n">getrepr</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;short&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspath</span><span class="o">.</span><span class="n">ImportMismatchError</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectError</span><span class="p">(</span>
                <span class="s2">&quot;import file mismatch:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;imported module </span><span class="si">%r</span><span class="s2"> has this __file__ attribute:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;which is not the same as the test file we want to collect:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;HINT: remove __pycache__ / .pyc files and/or use a &quot;</span>
                <span class="s2">&quot;unique basename for your test file modules&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">_pytest._code.code</span> <span class="kn">import</span> <span class="n">ExceptionInfo</span>

            <span class="n">exc_info</span> <span class="o">=</span> <span class="n">ExceptionInfo</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_traceback</span><span class="p">)</span>
            <span class="n">exc_repr</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">exc_info</span><span class="o">.</span><span class="n">getrepr</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;short&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span>
                <span class="k">else</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">exconly</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">formatted_tb</span> <span class="o">=</span> <span class="n">safe_str</span><span class="p">(</span><span class="n">exc_repr</span><span class="p">)</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectError</span><span class="p">(</span>
                <span class="s2">&quot;ImportError while importing test module &#39;</span><span class="si">{fspath}</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Hint: make sure your test modules/packages have valid Python names.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Traceback:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="si">{traceback}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fspath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fspath</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="n">formatted_tb</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">Skipped</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">allow_module_level</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectError</span><span class="p">(</span>
                <span class="s2">&quot;Using pytest.skip outside of a test is not allowed. &quot;</span>
                <span class="s2">&quot;To decorate a test function, use the @pytest.mark.skip &quot;</span>
                <span class="s2">&quot;or @pytest.mark.skipif decorators instead, and to skip a &quot;</span>
                <span class="s2">&quot;module use `pytestmark = pytest.mark.{skip,skipif}.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">consider_module</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mod</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">setup_module</span> <span class="o">=</span> <span class="n">_get_xunit_setup_teardown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;setUpModule&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setup_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">setup_module</span> <span class="o">=</span> <span class="n">_get_xunit_setup_teardown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;setup_module&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setup_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">setup_module</span><span class="p">()</span>

        <span class="n">teardown_module</span> <span class="o">=</span> <span class="n">_get_xunit_setup_teardown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;tearDownModule&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">teardown_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">teardown_module</span> <span class="o">=</span> <span class="n">_get_xunit_setup_teardown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;teardown_module&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">teardown_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">teardown_module</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">Package</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fspath</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nodeid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">session</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">FSCollector</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">fspath</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">nodeid</span><span class="o">=</span><span class="n">nodeid</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">fspath</span><span class="o">.</span><span class="n">dirname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">trace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_norecursepatterns</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">_norecursepatterns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fspath</span> <span class="o">=</span> <span class="n">fspath</span>

    <span class="k">def</span> <span class="nf">_recurse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dirpath</span><span class="o">.</span><span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;__pycache__&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">ihook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gethookproxy</span><span class="p">(</span><span class="n">dirpath</span><span class="o">.</span><span class="n">dirpath</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_ignore_collect</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norecursepatterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dirpath</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">=</span><span class="n">pat</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="n">ihook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gethookproxy</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
        <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_collect_directory</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">gethookproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fspath</span><span class="p">):</span>
        <span class="c1"># check if we have the common case of running</span>
        <span class="c1"># hooks with all conftest.py filesall conftest.py</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span>
        <span class="n">my_conftestmodules</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">_getconftestmodules</span><span class="p">(</span><span class="n">fspath</span><span class="p">)</span>
        <span class="n">remove_mods</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">_conftest_plugins</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">my_conftestmodules</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_mods</span><span class="p">:</span>
            <span class="c1"># one or more conftests are not in use at this fspath</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">FSHookProxy</span><span class="p">(</span><span class="n">fspath</span><span class="p">,</span> <span class="n">pm</span><span class="p">,</span> <span class="n">remove_mods</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># all plugis are active for this fspath</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hook</span>
        <span class="k">return</span> <span class="n">proxy</span>

    <span class="k">def</span> <span class="nf">_collectfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">handle_dupes</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ihook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gethookproxy</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isinitpath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_ignore_collect</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">()</span>

        <span class="k">if</span> <span class="n">handle_dupes</span><span class="p">:</span>
            <span class="n">keepduplicates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;keepduplicates&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keepduplicates</span><span class="p">:</span>
                <span class="n">duplicate_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">_duplicatepaths</span>
                <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">duplicate_paths</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">duplicate_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspath</span> <span class="o">==</span> <span class="n">path</span><span class="p">:</span>  <span class="c1"># __init__.py</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_collect_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">isinitpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_initialpaths</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">this_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspath</span><span class="o">.</span><span class="n">dirpath</span><span class="p">()</span>
        <span class="n">init_module</span> <span class="o">=</span> <span class="n">this_path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">init_module</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">path_matches_patterns</span><span class="p">(</span>
            <span class="n">init_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="s2">&quot;python_files&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">yield</span> <span class="n">Module</span><span class="p">(</span><span class="n">init_module</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">pkg_prefixes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">this_path</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">rec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">,</span> <span class="n">bf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="c1"># We will visit our own __init__.py file, in which case we skip it.</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;__init__.py&quot;</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">dirpath</span><span class="p">()</span> <span class="o">==</span> <span class="n">this_path</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="n">parts_</span> <span class="o">=</span> <span class="n">parts</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">strpath</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">pkg_prefix</span> <span class="ow">in</span> <span class="n">parts_</span> <span class="ow">and</span> <span class="n">pkg_prefix</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">path</span>
                <span class="k">for</span> <span class="n">pkg_prefix</span> <span class="ow">in</span> <span class="n">pkg_prefixes</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">()</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">pkg_prefixes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collectfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">_get_xunit_setup_teardown</span><span class="p">(</span><span class="n">holder</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">param_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a callable to perform xunit-style setup or teardown if</span>
<span class="sd">    the function exists in the ``holder`` object.</span>
<span class="sd">    The ``param_obj`` parameter is the parameter which will be passed to the function</span>
<span class="sd">    when the callable is called without arguments, defaults to the ``holder`` object.</span>
<span class="sd">    Return ``None`` if a suitable callable is not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">param_obj</span> <span class="o">=</span> <span class="n">param_obj</span> <span class="k">if</span> <span class="n">param_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">holder</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">_get_xunit_func</span><span class="p">(</span><span class="n">holder</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">arg_count</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_argcount</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="n">arg_count</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">arg_count</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">result</span><span class="p">(</span><span class="n">param_obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_get_xunit_func</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the attribute from the given object to be used as a setup/teardown</span>
<span class="sd">    xunit-style function, but only if not marked as a fixture to</span>
<span class="sd">    avoid calling it twice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">getfixturemarker</span><span class="p">(</span><span class="n">meth</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">meth</span>


<div class="viewcode-block" id="Class"><a class="viewcode-back" href="../../reference.html#_pytest.python.Class">[docs]</a><span class="k">class</span> <span class="nc">Class</span><span class="p">(</span><span class="n">PyCollector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Collector for test methods. &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Class.collect"><a class="viewcode-back" href="../../reference.html#_pytest.python.Class.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">safe_getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__test__&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">hasinit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="n">PytestWarning</span><span class="p">(</span>
                    <span class="s2">&quot;cannot collect test class </span><span class="si">%r</span><span class="s2"> because it has a &quot;</span>
                    <span class="s2">&quot;__init__ constructor&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">hasnew</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="n">PytestWarning</span><span class="p">(</span>
                    <span class="s2">&quot;cannot collect test class </span><span class="si">%r</span><span class="s2"> because it has a &quot;</span>
                    <span class="s2">&quot;__new__ constructor&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_getcustomclass</span><span class="p">(</span><span class="s2">&quot;Instance&quot;</span><span class="p">)(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;()&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">setup_class</span> <span class="o">=</span> <span class="n">_get_xunit_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;setup_class&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setup_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">setup_class</span> <span class="o">=</span> <span class="n">getimfunc</span><span class="p">(</span><span class="n">setup_class</span><span class="p">)</span>
            <span class="n">setup_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>

        <span class="n">fin_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;teardown_class&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fin_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fin_class</span> <span class="o">=</span> <span class="n">getimfunc</span><span class="p">(</span><span class="n">fin_class</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">fin_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">Instance</span><span class="p">(</span><span class="n">PyCollector</span><span class="p">):</span>
    <span class="n">_ALLOW_MARKERS</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># hack, destroy later</span>
    <span class="c1"># instances share the object with their parents in a way</span>
    <span class="c1"># that duplicates markers instances if not taken out</span>
    <span class="c1"># can be removed at node structure reorganization time</span>

    <span class="k">def</span> <span class="nf">_getobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">parsefactories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Instance</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">newinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getobj</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span>


<span class="k">class</span> <span class="nc">FunctionMixin</span><span class="p">(</span><span class="n">PyobjMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; mixin for the code common to Function and Generator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; perform setup for this test function. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_preservedparent&quot;</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preservedparent</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Instance</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">newinstance</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getobj</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">obj</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">setup_name</span> <span class="o">=</span> <span class="s2">&quot;setup_method&quot;</span>
            <span class="n">teardown_name</span> <span class="o">=</span> <span class="s2">&quot;teardown_method&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">setup_name</span> <span class="o">=</span> <span class="s2">&quot;setup_function&quot;</span>
            <span class="n">teardown_name</span> <span class="o">=</span> <span class="s2">&quot;teardown_function&quot;</span>
        <span class="n">setup_func_or_method</span> <span class="o">=</span> <span class="n">_get_xunit_setup_teardown</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span> <span class="n">setup_name</span><span class="p">,</span> <span class="n">param_obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">setup_func_or_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">setup_func_or_method</span><span class="p">()</span>
        <span class="n">teardown_func_or_method</span> <span class="o">=</span> <span class="n">_get_xunit_setup_teardown</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span> <span class="n">teardown_name</span><span class="p">,</span> <span class="n">param_obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">teardown_func_or_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">teardown_func_or_method</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prunetraceback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excinfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_obj&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">fulltrace</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">_code</span><span class="o">.</span><span class="n">Code</span><span class="p">(</span><span class="n">get_real_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">firstlineno</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">firstlineno</span>
            <span class="n">traceback</span> <span class="o">=</span> <span class="n">excinfo</span><span class="o">.</span><span class="n">traceback</span>
            <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">firstlineno</span><span class="o">=</span><span class="n">firstlineno</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ntraceback</span> <span class="o">==</span> <span class="n">traceback</span><span class="p">:</span>
                <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">ntraceback</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ntraceback</span> <span class="o">==</span> <span class="n">traceback</span><span class="p">:</span>
                    <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">ntraceback</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_traceback</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ntraceback</span><span class="p">:</span>
                        <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">traceback</span>

            <span class="n">excinfo</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="n">ntraceback</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
            <span class="c1"># issue364: mark all but first and last frames to</span>
            <span class="c1"># only show a single-line message for each frame</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">tbstyle</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">excinfo</span><span class="o">.</span><span class="n">traceback</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">excinfo</span><span class="o">.</span><span class="n">traceback</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">set_repr_style</span><span class="p">(</span><span class="s2">&quot;short&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">repr_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excinfo</span><span class="p">,</span> <span class="n">outerr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">outerr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;XXX outerr usage is deprecated&quot;</span>
        <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">tbstyle</span>
        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;long&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_failure_py</span><span class="p">(</span><span class="n">excinfo</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Generator</span><span class="p">(</span><span class="n">FunctionMixin</span><span class="p">,</span> <span class="n">PyCollector</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># test generators are seen as collectors but they also</span>
        <span class="c1"># invoke setup/teardown on popular request</span>
        <span class="c1"># (induced by the common &quot;test_*&quot; naming shared with normal tests)</span>
        <span class="kn">from</span> <span class="nn">_pytest</span> <span class="kn">import</span> <span class="n">deprecated</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_setupstate</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># see FunctionMixin.setup and test_setupstate_is_preserved_134</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preservedparent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">obj</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">()):</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcallargs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">call</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> yielded non callable test </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">call</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;[&#39;</span><span class="si">%s</span><span class="s2">&#39;]&quot;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> generated tests with non-unique name </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">seen</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="c1"># ignore our own deprecation warning</span>
                <span class="n">function_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Function</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function_class</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">callobj</span><span class="o">=</span><span class="n">call</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">deprecated</span><span class="o">.</span><span class="n">YIELD_TESTS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">getcallargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">,)</span>
        <span class="c1"># explicit naming</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">call</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">args</span>


<span class="k">def</span> <span class="nf">hasinit</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">init</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">init</span> <span class="o">!=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__init__</span>


<span class="k">def</span> <span class="nf">hasnew</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">new</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__new__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new</span> <span class="o">!=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span>


<span class="k">class</span> <span class="nc">CallSpec2</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metafunc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metafunc</span> <span class="o">=</span> <span class="n">metafunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_globalid</span> <span class="o">=</span> <span class="n">NOTSET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_globalparam</span> <span class="o">=</span> <span class="n">NOTSET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg2scopenum</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># used for sorting parametrized resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">CallSpec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metafunc</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">funcargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcargs</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">marks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">_arg2scopenum</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_arg2scopenum</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">_idlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_idlist</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">_globalid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalid</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">_globalparam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalparam</span>
        <span class="k">return</span> <span class="n">cs</span>

    <span class="k">def</span> <span class="nf">_checkargnotcontained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">or</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;duplicate </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">getparam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalparam</span> <span class="ow">is</span> <span class="n">NOTSET</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalparam</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idlist</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">setmulti2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valtypes</span><span class="p">,</span> <span class="n">argnames</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">marks</span><span class="p">,</span> <span class="n">scopenum</span><span class="p">,</span> <span class="n">param_index</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">valset</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkargnotcontained</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">valtype_for_arg</span> <span class="o">=</span> <span class="n">valtypes</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valtype_for_arg</span><span class="p">)[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arg2scopenum</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">scopenum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">normalize_mark_list</span><span class="p">(</span><span class="n">marks</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">setall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcargs</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">funcargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkargnotcontained</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">funcargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTSET</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_idlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTSET</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalparam</span> <span class="ow">is</span> <span class="n">NOTSET</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_globalparam</span> <span class="o">=</span> <span class="n">param</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">funcargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arg2scopenum</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">scopenum_function</span>


<div class="viewcode-block" id="Metafunc"><a class="viewcode-back" href="../../reference.html#_pytest.python.Metafunc">[docs]</a><span class="k">class</span> <span class="nc">Metafunc</span><span class="p">(</span><span class="n">fixtures</span><span class="o">.</span><span class="n">FuncargnamesCompatAttr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Metafunc objects are passed to the :func:`pytest_generate_tests &lt;_pytest.hookspec.pytest_generate_tests&gt;` hook.</span>
<span class="sd">    They help to inspect a test function and to generate tests according to</span>
<span class="sd">    test configuration or values specified in the class or module where a</span>
<span class="sd">    test function is defined.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">fixtureinfo</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">FunctionDefinition</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;DefinitionMock&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">definition</span> <span class="o">=</span> <span class="n">definition</span>

        <span class="c1">#: access to the :class:`_pytest.config.Config` object for the test session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="c1">#: the module object where the test function is defined in.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>

        <span class="c1">#: underlying python test function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">obj</span>

        <span class="c1">#: set of fixture names required by the test function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixturenames</span> <span class="o">=</span> <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">names_closure</span>

        <span class="c1">#: class object where the test function is defined in or ``None``.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="bp">cls</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span> <span class="o">=</span> <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">name2fixturedefs</span>

<div class="viewcode-block" id="Metafunc.parametrize"><a class="viewcode-back" href="../../reference.html#_pytest.python.Metafunc.parametrize">[docs]</a>    <span class="k">def</span> <span class="nf">parametrize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argnames</span><span class="p">,</span> <span class="n">argvalues</span><span class="p">,</span> <span class="n">indirect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add new invocations to the underlying test function using the list</span>
<span class="sd">        of argvalues for the given argnames.  Parametrization is performed</span>
<span class="sd">        during the collection phase.  If you need to setup expensive resources</span>
<span class="sd">        see about setting indirect to do it rather at test setup time.</span>

<span class="sd">        :arg argnames: a comma-separated string denoting one or more argument</span>
<span class="sd">                       names, or a list/tuple of argument strings.</span>

<span class="sd">        :arg argvalues: The list of argvalues determines how often a</span>
<span class="sd">            test is invoked with different argument values.  If only one</span>
<span class="sd">            argname was specified argvalues is a list of values.  If N</span>
<span class="sd">            argnames were specified, argvalues must be a list of N-tuples,</span>
<span class="sd">            where each tuple-element specifies a value for its respective</span>
<span class="sd">            argname.</span>

<span class="sd">        :arg indirect: The list of argnames or boolean. A list of arguments&#39;</span>
<span class="sd">            names (subset of argnames). If True the list contains all names from</span>
<span class="sd">            the argnames. Each argvalue corresponding to an argname in this list will</span>
<span class="sd">            be passed as request.param to its respective argname fixture</span>
<span class="sd">            function so that it can perform more expensive setups during the</span>
<span class="sd">            setup phase of a test rather than at collection time.</span>

<span class="sd">        :arg ids: list of string ids, or a callable.</span>
<span class="sd">            If strings, each is corresponding to the argvalues so that they are</span>
<span class="sd">            part of the test id. If None is given as id of specific test, the</span>
<span class="sd">            automatically generated id for that argument will be used.</span>
<span class="sd">            If callable, it should take one argument (a single argvalue) and return</span>
<span class="sd">            a string or return None. If None, the automatically generated id for that</span>
<span class="sd">            argument will be used.</span>
<span class="sd">            If no ids are provided they will be generated automatically from</span>
<span class="sd">            the argvalues.</span>

<span class="sd">        :arg scope: if specified it denotes the scope of the parameters.</span>
<span class="sd">            The scope is used for grouping tests by parameter instances.</span>
<span class="sd">            It will also override any fixture-function defined scope, allowing</span>
<span class="sd">            to set a dynamic scope using test context or configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">_pytest.fixtures</span> <span class="kn">import</span> <span class="n">scope2index</span>
        <span class="kn">from</span> <span class="nn">_pytest.mark</span> <span class="kn">import</span> <span class="n">ParameterSet</span>

        <span class="n">argnames</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">ParameterSet</span><span class="o">.</span><span class="n">_for_parametrize</span><span class="p">(</span>
            <span class="n">argnames</span><span class="p">,</span>
            <span class="n">argvalues</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">function_definition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="n">argvalues</span>

        <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="n">_find_parametrized_scope</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="p">,</span> <span class="n">indirect</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_if_using_arg_names</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">indirect</span><span class="p">)</span>

        <span class="n">arg_values_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_arg_value_types</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">indirect</span><span class="p">)</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_arg_ids</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="p">)</span>

        <span class="n">scopenum</span> <span class="o">=</span> <span class="n">scope2index</span><span class="p">(</span>
            <span class="n">scope</span><span class="p">,</span> <span class="n">descr</span><span class="o">=</span><span class="s2">&quot;parametrize() call in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># create the new calls: if we are parametrize() multiple times (by applying the decorator</span>
        <span class="c1"># more than once) then we accumulate those calls generating the cartesian product</span>
        <span class="c1"># of all calls</span>
        <span class="n">newcalls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">callspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span> <span class="ow">or</span> <span class="p">[</span><span class="n">CallSpec2</span><span class="p">(</span><span class="bp">self</span><span class="p">)]:</span>
            <span class="k">for</span> <span class="n">param_index</span><span class="p">,</span> <span class="p">(</span><span class="n">param_id</span><span class="p">,</span> <span class="n">param_set</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)):</span>
                <span class="n">newcallspec</span> <span class="o">=</span> <span class="n">callspec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">newcallspec</span><span class="o">.</span><span class="n">setmulti2</span><span class="p">(</span>
                    <span class="n">arg_values_types</span><span class="p">,</span>
                    <span class="n">argnames</span><span class="p">,</span>
                    <span class="n">param_set</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                    <span class="n">param_id</span><span class="p">,</span>
                    <span class="n">param_set</span><span class="o">.</span><span class="n">marks</span><span class="p">,</span>
                    <span class="n">scopenum</span><span class="p">,</span>
                    <span class="n">param_index</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">newcalls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newcallspec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span> <span class="o">=</span> <span class="n">newcalls</span></div>

    <span class="k">def</span> <span class="nf">_resolve_arg_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argnames</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resolves the actual ids for the given argnames, based on the ``ids`` parameter given</span>
<span class="sd">        to ``parametrize``.</span>

<span class="sd">        :param List[str] argnames: list of argument names passed to ``parametrize()``.</span>
<span class="sd">        :param ids: the ids parameter of the parametrized call (see docs).</span>
<span class="sd">        :param List[ParameterSet] parameters: the list of parameter values, same size as ``argnames``.</span>
<span class="sd">        :param Item item: the item that generated this parametrized call.</span>
<span class="sd">        :rtype: List[str]</span>
<span class="sd">        :return: the list of ids for each argname given</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">py.io</span> <span class="kn">import</span> <span class="n">saferepr</span>

        <span class="n">idfn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="n">idfn</span> <span class="o">=</span> <span class="n">ids</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;In </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> parameter sets specified, with different number of ids: </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="n">fail</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)),</span> <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">id_value</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">id_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;In </span><span class="si">{}</span><span class="s2">: ids must be list of strings, found: </span><span class="si">{}</span><span class="s2"> (type: </span><span class="si">{!r}</span><span class="s2">)&quot;</span>
                    <span class="n">fail</span><span class="p">(</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">saferepr</span><span class="p">(</span><span class="n">id_value</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">id_value</span><span class="p">)),</span>
                        <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">idmaker</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">idfn</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ids</span>

    <span class="k">def</span> <span class="nf">_resolve_arg_value_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argnames</span><span class="p">,</span> <span class="n">indirect</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resolves if each parametrized argument must be considered a parameter to a fixture or a &quot;funcarg&quot;</span>
<span class="sd">        to the function, based on the ``indirect`` parameter of the parametrized() call.</span>

<span class="sd">        :param List[str] argnames: list of argument names passed to ``parametrize()``.</span>
<span class="sd">        :param indirect: same ``indirect`` parameter of ``parametrize()``.</span>
<span class="sd">        :rtype: Dict[str, str]</span>
<span class="sd">            A dict mapping each arg name to either:</span>
<span class="sd">            * &quot;params&quot; if the argname should be the parameter of a fixture of the same name.</span>
<span class="sd">            * &quot;funcargs&quot; if the argname should be a parameter to the parametrized test function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valtypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">indirect</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">valtypes</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">indirect</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">valtypes</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="s2">&quot;funcargs&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indirect</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">valtypes</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="s2">&quot;funcargs&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">indirect</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">:</span>
                    <span class="n">fail</span><span class="p">(</span>
                        <span class="s2">&quot;In </span><span class="si">{}</span><span class="s2">: indirect fixture &#39;</span><span class="si">{}</span><span class="s2">&#39; doesn&#39;t exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">arg</span>
                        <span class="p">),</span>
                        <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">valtypes</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;params&quot;</span>
        <span class="k">return</span> <span class="n">valtypes</span>

    <span class="k">def</span> <span class="nf">_validate_if_using_arg_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argnames</span><span class="p">,</span> <span class="n">indirect</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if all argnames are being used, by default values, or directly/indirectly.</span>

<span class="sd">        :param List[str] argnames: list of argument names passed to ``parametrize()``.</span>
<span class="sd">        :param indirect: same ``indirect`` parameter of ``parametrize()``.</span>
<span class="sd">        :raise ValueError: if validation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_arg_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_default_arg_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">))</span>
        <span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">default_arg_names</span><span class="p">:</span>
                    <span class="n">fail</span><span class="p">(</span>
                        <span class="s2">&quot;In </span><span class="si">{}</span><span class="s2">: function already takes an argument &#39;</span><span class="si">{}</span><span class="s2">&#39; with a default value&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">func_name</span><span class="p">,</span> <span class="n">arg</span>
                        <span class="p">),</span>
                        <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indirect</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fixture&quot;</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">indirect</span> <span class="k">else</span> <span class="s2">&quot;argument&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fixture&quot;</span> <span class="k">if</span> <span class="n">indirect</span> <span class="k">else</span> <span class="s2">&quot;argument&quot;</span>
                    <span class="n">fail</span><span class="p">(</span>
                        <span class="s2">&quot;In </span><span class="si">{}</span><span class="s2">: function uses no </span><span class="si">{}</span><span class="s2"> &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">arg</span><span class="p">),</span>
                        <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>

<div class="viewcode-block" id="Metafunc.addcall"><a class="viewcode-back" href="../../reference.html#_pytest.python.Metafunc.addcall">[docs]</a>    <span class="k">def</span> <span class="nf">addcall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">NOTSET</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="n">NOTSET</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a new call to the underlying test function during the collection phase of a test run.</span>

<span class="sd">        .. deprecated:: 3.3</span>

<span class="sd">            Use :meth:`parametrize` instead.</span>

<span class="sd">        Note that request.addcall() is called during the test collection phase prior and</span>
<span class="sd">        independently to actual test execution.  You should only use addcall()</span>
<span class="sd">        if you need to specify multiple arguments of a test function.</span>

<span class="sd">        :arg funcargs: argument keyword dictionary used when invoking</span>
<span class="sd">            the test function.</span>

<span class="sd">        :arg id: used for reporting and identification purposes.  If you</span>
<span class="sd">            don&#39;t supply an `id` an automatic unique id will be generated.</span>

<span class="sd">        :arg param: a parameter which will be exposed to a later fixture function</span>
<span class="sd">            invocation through the ``request.param`` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">deprecated</span><span class="o">.</span><span class="n">METAFUNC_ADD_CALL</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">funcargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">funcargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">funcargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">funcargs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">:</span>
                    <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;funcarg </span><span class="si">%r</span><span class="s2"> not used in this function.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">funcargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;id=None not allowed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="n">NOTSET</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;duplicate id </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">CallSpec2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">setall</span><span class="p">(</span><span class="n">funcargs</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_find_parametrized_scope</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">arg2fixturedefs</span><span class="p">,</span> <span class="n">indirect</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the most appropriate scope for a parametrized call based on its arguments.</span>

<span class="sd">    When there&#39;s at least one direct argument, always use &quot;function&quot; scope.</span>

<span class="sd">    When a test function is parametrized and all its arguments are indirect</span>
<span class="sd">    (e.g. fixtures), return the most narrow scope based on the fixtures used.</span>

<span class="sd">    Related to issue #1832, based on code posted by @Kingdread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">_pytest.fixtures</span> <span class="kn">import</span> <span class="n">scopes</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indirect</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">all_arguments_are_fixtures</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indirect</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">argnames</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_arguments_are_fixtures</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">indirect</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">all_arguments_are_fixtures</span><span class="p">:</span>
        <span class="n">fixturedefs</span> <span class="o">=</span> <span class="n">arg2fixturedefs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">used_scopes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">fixturedef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scope</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fixturedef</span> <span class="ow">in</span> <span class="n">fixturedefs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">argnames</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">used_scopes</span><span class="p">:</span>
            <span class="c1"># Takes the most narrow scope from used fixtures</span>
            <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">scopes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">used_scopes</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">scope</span>

    <span class="k">return</span> <span class="s2">&quot;function&quot;</span>


<span class="k">def</span> <span class="nf">_idval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idfn</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">idfn</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">idfn</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># See issue https://github.com/pytest-dev/pytest/issues/2169</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;While trying to determine id of parameter </span><span class="si">{}</span><span class="s2"> at position &quot;</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> the following exception was raised:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;This warning will be an error error in pytest-4.0.&quot;</span>
            <span class="n">item</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">RemovedInPytest4Warning</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ascii_escaped</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">hook_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_make_parametrize_id</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">argname</span><span class="o">=</span><span class="n">argname</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">hook_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hook_id</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">STRING_TYPES</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ascii_escaped</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">REGEX_TYPE</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ascii_escaped</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">enum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">isclass</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isfunction</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_idvalset</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">parameterset</span><span class="p">,</span> <span class="n">argnames</span><span class="p">,</span> <span class="n">idfn</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">parameterset</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parameterset</span><span class="o">.</span><span class="n">id</span>
    <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">this_id</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_idval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idfn</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">argname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameterset</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">argnames</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">this_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ascii_escaped</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">idmaker</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">parametersets</span><span class="p">,</span> <span class="n">idfn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_idvalset</span><span class="p">(</span><span class="n">valindex</span><span class="p">,</span> <span class="n">parameterset</span><span class="p">,</span> <span class="n">argnames</span><span class="p">,</span> <span class="n">idfn</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">valindex</span><span class="p">,</span> <span class="n">parameterset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parametersets</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
        <span class="c1"># The ids are not unique</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">testid</span> <span class="k">for</span> <span class="n">testid</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">if</span> <span class="n">ids</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">testid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">counters</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">testid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">testid</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="n">ids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">testid</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">counters</span><span class="p">[</span><span class="n">testid</span><span class="p">])</span>
                <span class="n">counters</span><span class="p">[</span><span class="n">testid</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">ids</span>


<span class="k">def</span> <span class="nf">show_fixtures_per_test</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">_pytest.main</span> <span class="kn">import</span> <span class="n">wrap_session</span>

    <span class="k">return</span> <span class="n">wrap_session</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">_show_fixtures_per_test</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_show_fixtures_per_test</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">_pytest.config</span>

    <span class="n">session</span><span class="o">.</span><span class="n">perform_collect</span><span class="p">()</span>
    <span class="n">curdir</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">create_terminal_writer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_best_relpath</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">getlocation</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">curdir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">curdir</span><span class="o">.</span><span class="n">bestrelpath</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_fixture</span><span class="p">(</span><span class="n">fixture_def</span><span class="p">):</span>
        <span class="n">argname</span> <span class="o">=</span> <span class="n">fixture_def</span><span class="o">.</span><span class="n">argname</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">argname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bestrel</span> <span class="o">=</span> <span class="n">get_best_relpath</span><span class="p">(</span><span class="n">fixture_def</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
            <span class="n">funcargspec</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> -- </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">bestrel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">funcargspec</span> <span class="o">=</span> <span class="n">argname</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">funcargspec</span><span class="p">,</span> <span class="n">green</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fixture_doc</span> <span class="o">=</span> <span class="n">fixture_def</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="k">if</span> <span class="n">fixture_doc</span><span class="p">:</span>
            <span class="n">write_docstring</span><span class="p">(</span><span class="n">tw</span><span class="p">,</span> <span class="n">fixture_doc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;    no docstring available&quot;</span><span class="p">,</span> <span class="n">red</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_item</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_fixtureinfo</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># doctests items have no _fixtureinfo attribute</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="o">.</span><span class="n">name2fixturedefs</span><span class="p">:</span>
            <span class="c1"># this test item does not use any fixtures</span>
            <span class="k">return</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">()</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">sep</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;fixtures used by </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">sep</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_best_relpath</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">function</span><span class="p">)))</span>
        <span class="c1"># dict key not used in loop but needed for sorting</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">fixturedefs</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">name2fixturedefs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">assert</span> <span class="n">fixturedefs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fixturedefs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># last item is expected to be the one used by the test item</span>
            <span class="n">write_fixture</span><span class="p">(</span><span class="n">fixturedefs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">session_item</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
        <span class="n">write_item</span><span class="p">(</span><span class="n">session_item</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">showfixtures</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">_pytest.main</span> <span class="kn">import</span> <span class="n">wrap_session</span>

    <span class="k">return</span> <span class="n">wrap_session</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">_showfixtures_main</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_showfixtures_main</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">_pytest.config</span>

    <span class="n">session</span><span class="o">.</span><span class="n">perform_collect</span><span class="p">()</span>
    <span class="n">curdir</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">create_terminal_writer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">)</span>

    <span class="n">fm</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span>

    <span class="n">available</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">argname</span><span class="p">,</span> <span class="n">fixturedefs</span> <span class="ow">in</span> <span class="n">fm</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">fixturedefs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fixturedefs</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">fixturedef</span> <span class="ow">in</span> <span class="n">fixturedefs</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">getlocation</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">curdir</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">argname</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">argname</span><span class="p">,</span> <span class="n">loc</span><span class="p">))</span>
            <span class="n">available</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">baseid</span><span class="p">),</span>
                    <span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                    <span class="n">curdir</span><span class="o">.</span><span class="n">bestrelpath</span><span class="p">(</span><span class="n">loc</span><span class="p">),</span>
                    <span class="n">fixturedef</span><span class="o">.</span><span class="n">argname</span><span class="p">,</span>
                    <span class="n">fixturedef</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="n">available</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">currentmodule</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">baseid</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">bestrel</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">fixturedef</span> <span class="ow">in</span> <span class="n">available</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">currentmodule</span> <span class="o">!=</span> <span class="n">module</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_pytest.&quot;</span><span class="p">):</span>
                <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">()</span>
                <span class="n">tw</span><span class="o">.</span><span class="n">sep</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;fixtures defined from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,))</span>
                <span class="n">currentmodule</span> <span class="o">=</span> <span class="n">module</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">argname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">funcargspec</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -- </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">bestrel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">funcargspec</span> <span class="o">=</span> <span class="n">argname</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">funcargspec</span><span class="p">,</span> <span class="n">green</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">getlocation</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">curdir</span><span class="p">)</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
            <span class="n">write_docstring</span><span class="p">(</span><span class="n">tw</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">: no docstring available&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">loc</span><span class="p">,),</span> <span class="n">red</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_docstring</span><span class="p">(</span><span class="n">tw</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
    <span class="n">INDENT</span> <span class="o">=</span> <span class="s2">&quot;    &quot;</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
        <span class="n">firstline</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">firstline</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">doc</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">firstline</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">+</span> <span class="n">firstline</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">rest</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dedent</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">tw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Function"><a class="viewcode-back" href="../../reference.html#_pytest.python.Function">[docs]</a><span class="k">class</span> <span class="nc">Function</span><span class="p">(</span><span class="n">FunctionMixin</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Item</span><span class="p">,</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">FuncargnamesCompatAttr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a Function Item is responsible for setting up and executing a</span>
<span class="sd">    Python test function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_genid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># disable since functions handle it themselves</span>
    <span class="n">_ALLOW_MARKERS</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">callspec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">callobj</span><span class="o">=</span><span class="n">NOTSET</span><span class="p">,</span>
        <span class="n">keywords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fixtureinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">originalname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Function</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">if</span> <span class="n">callobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTSET</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">callobj</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">own_markers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_unpacked_marks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">callspec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callspec</span> <span class="o">=</span> <span class="n">callspec</span>
            <span class="c1"># this is total hostile and a mess</span>
            <span class="c1"># keywords are broken by design by now</span>
            <span class="c1"># this will be redeemed later</span>
            <span class="k">for</span> <span class="n">mark</span> <span class="ow">in</span> <span class="n">callspec</span><span class="o">.</span><span class="n">marks</span><span class="p">:</span>
                <span class="c1"># feel free to cry, this was broken for years before</span>
                <span class="c1"># and keywords cant fix it per design</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="n">mark</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mark</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">own_markers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">normalize_mark_list</span><span class="p">(</span><span class="n">callspec</span><span class="o">.</span><span class="n">marks</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fixtureinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fixtureinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">getfixtureinfo</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">funcargs</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isyieldedfunction</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixtureinfo</span> <span class="o">=</span> <span class="n">fixtureinfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixturenames</span> <span class="o">=</span> <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">names_closure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initrequest</span><span class="p">()</span>

        <span class="c1">#: original function name, without any decorations (for example</span>
        <span class="c1">#: parametrization adds a ``&quot;[...]&quot;`` suffix to function names).</span>
        <span class="c1">#:</span>
        <span class="c1">#: .. versionadded:: 3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">originalname</span> <span class="o">=</span> <span class="n">originalname</span>

    <span class="k">def</span> <span class="nf">_initrequest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isyieldedfunction</span><span class="p">():</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;callspec&quot;</span>
            <span class="p">),</span> <span class="s2">&quot;yielded functions (deprecated) cannot have funcargs&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;callspec&quot;</span><span class="p">):</span>
                <span class="n">callspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callspec</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">callspec</span><span class="o">.</span><span class="n">funcargs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_genid</span> <span class="o">=</span> <span class="n">callspec</span><span class="o">.</span><span class="n">id</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">callspec</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">callspec</span><span class="o">.</span><span class="n">param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">FixtureRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;underlying python &#39;function&#39; object&quot;</span>
        <span class="k">return</span> <span class="n">getimfunc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>  <span class="c1"># parametrization</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_pyfuncitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;(compatonly) for code expecting pytest-2.2 style request objects&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_isyieldedfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_args&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="Function.runtest"><a class="viewcode-back" href="../../reference.html#_pytest.python.Function.runtest">[docs]</a>    <span class="k">def</span> <span class="nf">runtest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; execute the underlying test function. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ihook</span><span class="o">.</span><span class="n">pytest_pyfunc_call</span><span class="p">(</span><span class="n">pyfuncitem</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Function.setup"><a class="viewcode-back" href="../../reference.html#_pytest.python.Function.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Function</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="n">fixtures</span><span class="o">.</span><span class="n">fillfixtures</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">FunctionDefinition</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    internal hack until we get actual definition nodes instead of the</span>
<span class="sd">    crappy metafunc hack</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">runtest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;function definitions are not supposed to be used&quot;</span><span class="p">)</span>

    <span class="n">setup</span> <span class="o">=</span> <span class="n">runtest</span>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../../contents.html">pytest-3.10</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 20152018 , holger krekel and pytest-dev team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-7597274-13']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>