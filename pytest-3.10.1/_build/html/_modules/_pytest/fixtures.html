
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>_pytest.fixtures &#8212; pytest documentation</title>
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/pytest1favi.ico"/>
    <link rel="search" title="Search" href="../../search.html" />
  </head><body>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../../contents.html">pytest-3.10</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">

  <h1>Source code for _pytest.fixtures</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">py</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">more_itertools</span> <span class="kn">import</span> <span class="n">flatten</span>
<span class="kn">from</span> <span class="nn">py._code.code</span> <span class="kn">import</span> <span class="n">FormattedExcinfo</span>

<span class="kn">import</span> <span class="nn">_pytest</span>
<span class="kn">from</span> <span class="nn">_pytest</span> <span class="kn">import</span> <span class="n">nodes</span>
<span class="kn">from</span> <span class="nn">_pytest._code.code</span> <span class="kn">import</span> <span class="n">TerminalRepr</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">_format_args</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">_PytestWrapper</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">exc_clear</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">FuncargnamesCompatAttr</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">get_real_func</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">get_real_method</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">getfslineno</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">getfuncargnames</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">getimfunc</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">getlocation</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">is_generator</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">isclass</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">NOTSET</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">safe_getattr</span>
<span class="kn">from</span> <span class="nn">_pytest.deprecated</span> <span class="kn">import</span> <span class="n">FIXTURE_FUNCTION_CALL</span>
<span class="kn">from</span> <span class="nn">_pytest.deprecated</span> <span class="kn">import</span> <span class="n">FIXTURE_NAMED_REQUEST</span>
<span class="kn">from</span> <span class="nn">_pytest.outcomes</span> <span class="kn">import</span> <span class="n">fail</span>
<span class="kn">from</span> <span class="nn">_pytest.outcomes</span> <span class="kn">import</span> <span class="n">TEST_OUTCOME</span>

<span class="n">FIXTURE_MSG</span> <span class="o">=</span> <span class="s1">&#39;fixtures cannot have &quot;pytest_funcarg__&quot; prefix and be decorated with @pytest.fixture:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span>


<span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">PseudoFixtureDef</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">cached_result</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">()</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">pytest_sessionstart</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">_pytest.python</span>
    <span class="kn">import</span> <span class="nn">_pytest.nodes</span>

    <span class="n">scopename2class</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;package&quot;</span><span class="p">:</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">Package</span><span class="p">,</span>
            <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">Class</span><span class="p">,</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span><span class="p">,</span>
            <span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span> <span class="o">=</span> <span class="n">FixtureManager</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>


<span class="n">scopename2class</span> <span class="o">=</span> <span class="p">{}</span>


<span class="n">scope2props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="p">())</span>
<span class="n">scope2props</span><span class="p">[</span><span class="s2">&quot;package&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;fspath&quot;</span><span class="p">,)</span>
<span class="n">scope2props</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;fspath&quot;</span><span class="p">,</span> <span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="n">scope2props</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scope2props</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;cls&quot;</span><span class="p">,)</span>
<span class="n">scope2props</span><span class="p">[</span><span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scope2props</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;instance&quot;</span><span class="p">,)</span>
<span class="n">scope2props</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scope2props</span><span class="p">[</span><span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="s2">&quot;keywords&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">scopeproperty</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decoratescope</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">scopename</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">def</span> <span class="nf">provide</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="n">scope2props</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not available in </span><span class="si">%s</span><span class="s2">-scoped context&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scopename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">provide</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decoratescope</span>


<span class="k">def</span> <span class="nf">get_scope_package</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">fixturedef</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">pytest</span>

    <span class="bp">cls</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">Package</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">node</span>
    <span class="n">fixture_package_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">baseid</span><span class="p">,</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">current</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="nb">type</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span> <span class="ow">or</span> <span class="n">fixture_package_name</span> <span class="o">!=</span> <span class="n">current</span><span class="o">.</span><span class="n">nodeid</span>
    <span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">parent</span>
    <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">session</span>
    <span class="k">return</span> <span class="n">current</span>


<span class="k">def</span> <span class="nf">get_scope_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">scope</span><span class="p">):</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">scopename2class</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown scope&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_funcarg_pseudo_fixture_def</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">metafunc</span><span class="p">,</span> <span class="n">fixturemanager</span><span class="p">):</span>
    <span class="c1"># this function will transform all collected calls to a functions</span>
    <span class="c1"># if they use direct funcargs (i.e. direct parametrization)</span>
    <span class="c1"># because we want later test execution to be able to rely on</span>
    <span class="c1"># an existing FixtureDef structure for all arguments.</span>
    <span class="c1"># XXX we can probably avoid this algorithm  if we modify CallSpec2</span>
    <span class="c1"># to directly care for creating the fixturedefs within its methods.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">funcargs</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># this function call does not have direct parametrization</span>
    <span class="c1"># collect funcargs of all callspecs into a list of values</span>
    <span class="n">arg2params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">arg2scope</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">callspec</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">argname</span><span class="p">,</span> <span class="n">argvalue</span> <span class="ow">in</span> <span class="n">callspec</span><span class="o">.</span><span class="n">funcargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">argname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">callspec</span><span class="o">.</span><span class="n">params</span>
            <span class="n">callspec</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="n">argvalue</span>
            <span class="n">arg2params_list</span> <span class="o">=</span> <span class="n">arg2params</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">callspec</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg2params_list</span><span class="p">)</span>
            <span class="n">arg2params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">argvalue</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">argname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arg2scope</span><span class="p">:</span>
                <span class="n">scopenum</span> <span class="o">=</span> <span class="n">callspec</span><span class="o">.</span><span class="n">_arg2scopenum</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">scopenum_function</span><span class="p">)</span>
                <span class="n">arg2scope</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="n">scopes</span><span class="p">[</span><span class="n">scopenum</span><span class="p">]</span>
        <span class="n">callspec</span><span class="o">.</span><span class="n">funcargs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># register artificial FixtureDef&#39;s so that later at test execution</span>
    <span class="c1"># time we can rely on a proper FixtureDef to exist for fixture setup.</span>
    <span class="n">arg2fixturedefs</span> <span class="o">=</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">_arg2fixturedefs</span>
    <span class="k">for</span> <span class="n">argname</span><span class="p">,</span> <span class="n">valuelist</span> <span class="ow">in</span> <span class="n">arg2params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># if we have a scope that is higher than function we need</span>
        <span class="c1"># to make sure we only ever create an according fixturedef on</span>
        <span class="c1"># a per-scope basis. We thus store and cache the fixturedef on the</span>
        <span class="c1"># node related to the scope.</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">arg2scope</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">scope</span> <span class="o">!=</span> <span class="s2">&quot;function&quot;</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">get_scope_node</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;class&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span>
                <span class="c1"># use module-level collector for class-scope (for now)</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">collector</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">and</span> <span class="n">argname</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">_name2pseudofixturedef</span><span class="p">:</span>
            <span class="n">arg2fixturedefs</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">_name2pseudofixturedef</span><span class="p">[</span><span class="n">argname</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fixturedef</span> <span class="o">=</span> <span class="n">FixtureDef</span><span class="p">(</span>
                <span class="n">fixturemanager</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">argname</span><span class="p">,</span>
                <span class="n">get_direct_param_fixture_func</span><span class="p">,</span>
                <span class="n">arg2scope</span><span class="p">[</span><span class="n">argname</span><span class="p">],</span>
                <span class="n">valuelist</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">arg2fixturedefs</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fixturedef</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">_name2pseudofixturedef</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixturedef</span>


<span class="k">def</span> <span class="nf">getfixturemarker</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; return fixturemarker or None if it doesn&#39;t exist or raised</span>
<span class="sd">    exceptions.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;_pytestfixturefunction&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">TEST_OUTCOME</span><span class="p">:</span>
        <span class="c1"># some objects raise errors like request (from flask import request)</span>
        <span class="c1"># we don&#39;t expect them to be fixture functions</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">get_parametrized_fixture_keys</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">scopenum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; return list of keys for all parametrized arguments which match</span>
<span class="sd">    the specified scope. &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">scopenum</span> <span class="o">&lt;</span> <span class="n">scopenum_function</span>  <span class="c1"># function</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">callspec</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># cs.indices.items() is random order of argnames.  Need to</span>
        <span class="c1"># sort this so that different calls to</span>
        <span class="c1"># get_parametrized_fixture_keys will be deterministic.</span>
        <span class="k">for</span> <span class="n">argname</span><span class="p">,</span> <span class="n">param_index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">_arg2scopenum</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">!=</span> <span class="n">scopenum</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">scopenum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># session</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">param_index</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">scopenum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># package</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">param_index</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">fspath</span><span class="o">.</span><span class="n">dirpath</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">scopenum</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># module</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">param_index</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">fspath</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">scopenum</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># class</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">param_index</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">fspath</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">key</span>


<span class="c1"># algorithm for sorting on a per-parametrized resource setup basis</span>
<span class="c1"># it is called for scopenum==0 (session) first and performs sorting</span>
<span class="c1"># down to the lower scopes such as to minimize number of &quot;high scope&quot;</span>
<span class="c1"># setups and teardowns</span>


<span class="k">def</span> <span class="nf">reorder_items</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="n">argkeys_cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">items_by_argkey</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">scopenum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">scopenum_function</span><span class="p">):</span>
        <span class="n">argkeys_cache</span><span class="p">[</span><span class="n">scopenum</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">items_by_argkey</span><span class="p">[</span><span class="n">scopenum</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">deque</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">get_parametrized_fixture_keys</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">scopenum</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">keys</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="n">item_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">reorder_items_atscope</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">argkeys_cache</span><span class="p">,</span> <span class="n">items_by_argkey</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">fix_cache_order</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">argkeys_cache</span><span class="p">,</span> <span class="n">items_by_argkey</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">scopenum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">scopenum_function</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">argkeys_cache</span><span class="p">[</span><span class="n">scopenum</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">items_by_argkey</span><span class="p">[</span><span class="n">scopenum</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">reorder_items_atscope</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">argkeys_cache</span><span class="p">,</span> <span class="n">items_by_argkey</span><span class="p">,</span> <span class="n">scopenum</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">scopenum</span> <span class="o">&gt;=</span> <span class="n">scopenum_function</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">items</span>
    <span class="n">ignore</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">items_deque</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="n">items_done</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">scoped_items_by_argkey</span> <span class="o">=</span> <span class="n">items_by_argkey</span><span class="p">[</span><span class="n">scopenum</span><span class="p">]</span>
    <span class="n">scoped_argkeys_cache</span> <span class="o">=</span> <span class="n">argkeys_cache</span><span class="p">[</span><span class="n">scopenum</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">items_deque</span><span class="p">:</span>
        <span class="n">no_argkey_group</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">slicing_argkey</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">items_deque</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">items_deque</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items_done</span> <span class="ow">or</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">no_argkey_group</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">argkeys</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span>
                <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">scoped_argkeys_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">argkeys</span><span class="p">:</span>
                <span class="n">no_argkey_group</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">slicing_argkey</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">argkeys</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
                <span class="c1"># we don&#39;t have to remove relevant items from later in the deque because they&#39;ll just be ignored</span>
                <span class="n">matching_items</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scoped_items_by_argkey</span><span class="p">[</span><span class="n">slicing_argkey</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">matching_items</span><span class="p">):</span>
                    <span class="n">fix_cache_order</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">argkeys_cache</span><span class="p">,</span> <span class="n">items_by_argkey</span><span class="p">)</span>
                    <span class="n">items_deque</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">no_argkey_group</span><span class="p">:</span>
            <span class="n">no_argkey_group</span> <span class="o">=</span> <span class="n">reorder_items_atscope</span><span class="p">(</span>
                <span class="n">no_argkey_group</span><span class="p">,</span> <span class="n">argkeys_cache</span><span class="p">,</span> <span class="n">items_by_argkey</span><span class="p">,</span> <span class="n">scopenum</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">no_argkey_group</span><span class="p">:</span>
                <span class="n">items_done</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ignore</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">slicing_argkey</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">items_done</span>


<span class="k">def</span> <span class="nf">fillfixtures</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; fill missing funcargs for a test function. &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">_request</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c1"># XXX this special code path is only expected to execute</span>
        <span class="c1"># with the oejskit plugin.  It uses classes with funcargs</span>
        <span class="c1"># and we thus have to work a bit to allow this.</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span>
        <span class="n">fi</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getfixtureinfo</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">function</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">_fixtureinfo</span> <span class="o">=</span> <span class="n">fi</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">FixtureRequest</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">_fillfixtures</span><span class="p">()</span>
        <span class="c1"># prune out funcargs for jstests</span>
        <span class="n">newfuncargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fi</span><span class="o">.</span><span class="n">argnames</span><span class="p">:</span>
            <span class="n">newfuncargs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">funcargs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">function</span><span class="o">.</span><span class="n">funcargs</span> <span class="o">=</span> <span class="n">newfuncargs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">_fillfixtures</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_direct_param_fixture_func</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>


<span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">FuncFixtureInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># original function argument names</span>
    <span class="n">argnames</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">tuple</span><span class="p">)</span>
    <span class="c1"># argnames that function immediately requires. These include argnames +</span>
    <span class="c1"># fixture names specified via usefixtures and via autouse=True in fixture</span>
    <span class="c1"># definitions.</span>
    <span class="n">initialnames</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">tuple</span><span class="p">)</span>
    <span class="n">names_closure</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">()</span>  <span class="c1"># type: List[str]</span>
    <span class="n">name2fixturedefs</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">()</span>  <span class="c1"># type: List[str, List[FixtureDef]]</span>

    <span class="k">def</span> <span class="nf">prune_dependency_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recompute names_closure from initialnames and name2fixturedefs</span>

<span class="sd">        Can only reduce names_closure, which means that the new closure will</span>
<span class="sd">        always be a subset of the old one. The order is preserved.</span>

<span class="sd">        This method is needed because direct parametrization may shadow some</span>
<span class="sd">        of the fixtures that were included in the originally built dependency</span>
<span class="sd">        tree. In this way the dependency tree can get pruned, and the closure</span>
<span class="sd">        of argnames may get reduced.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">closure</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">working_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialnames</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">working_set</span><span class="p">:</span>
            <span class="n">argname</span> <span class="o">=</span> <span class="n">working_set</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="c1"># argname may be smth not included in the original names_closure,</span>
            <span class="c1"># in which case we ignore it. This currently happens with pseudo</span>
            <span class="c1"># FixtureDefs which wrap &#39;get_direct_param_fixture_func(request)&#39;.</span>
            <span class="c1"># So they introduce the new dependency &#39;request&#39; which might have</span>
            <span class="c1"># been missing in the original tree (closure).</span>
            <span class="k">if</span> <span class="n">argname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">closure</span> <span class="ow">and</span> <span class="n">argname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_closure</span><span class="p">:</span>
                <span class="n">closure</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">argname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name2fixturedefs</span><span class="p">:</span>
                    <span class="n">working_set</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name2fixturedefs</span><span class="p">[</span><span class="n">argname</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argnames</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">names_closure</span><span class="p">[:]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">closure</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">names_closure</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>


<div class="viewcode-block" id="FixtureRequest"><a class="viewcode-back" href="../../reference.html#pytest.FixtureRequest">[docs]</a><span class="k">class</span> <span class="nc">FixtureRequest</span><span class="p">(</span><span class="n">FuncargnamesCompatAttr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A request for a fixture from a test or fixture function.</span>

<span class="sd">    A request object gives access to the requesting test context</span>
<span class="sd">    and has an optional ``param`` attribute in case</span>
<span class="sd">    the fixture is parametrized indirectly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyfuncitem</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span> <span class="o">=</span> <span class="n">pyfuncitem</span>
        <span class="c1">#: fixture for which this request is being performed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixturename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#: Scope string, one of &quot;function&quot;, &quot;class&quot;, &quot;module&quot;, &quot;session&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="s2">&quot;function&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixture_defs</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># argname -&gt; FixtureDef</span>
        <span class="n">fixtureinfo</span> <span class="o">=</span> <span class="n">pyfuncitem</span><span class="o">.</span><span class="n">_fixtureinfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span> <span class="o">=</span> <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">name2fixturedefs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg2index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixturemanager</span> <span class="o">=</span> <span class="n">pyfuncitem</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fixturenames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;names of all active fixtures in this request&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">_fixtureinfo</span><span class="o">.</span><span class="n">names_closure</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixture_defs</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; underlying collection node (depends on current request scope)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getscopeitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getnextfixturedef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argname</span><span class="p">):</span>
        <span class="n">fixturedefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fixturedefs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># we arrive here because of a dynamic call to</span>
            <span class="c1"># getfixturevalue(argname) usage which was naturally</span>
            <span class="c1"># not known at parsing/collection time</span>
            <span class="n">parentid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">nodeid</span>
            <span class="n">fixturedefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">getfixturedefs</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">parentid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixturedefs</span>
        <span class="c1"># fixturedefs list is immutable so we maintain a decreasing index</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arg2index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">fixturedefs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="o">-</span><span class="n">index</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixturedefs</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">FixtureLookupError</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg2index</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">return</span> <span class="n">fixturedefs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; the pytest config object associated with this request. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">config</span>

    <span class="nd">@scopeproperty</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; test function object if the request has a per-function scope. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">obj</span>

    <span class="nd">@scopeproperty</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; class (can be None) where the test function was collected. &quot;&quot;&quot;</span>
        <span class="n">clscol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">_pytest</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">Class</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clscol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">clscol</span><span class="o">.</span><span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; instance (can be None) on which test function was collected. &quot;&quot;&quot;</span>
        <span class="c1"># unittest support hack, see _pytest.unittest.TestCaseFunction</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">_testcase</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="s2">&quot;__self__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@scopeproperty</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; python module object where the test function was collected. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">_pytest</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span><span class="o">.</span><span class="n">obj</span>

    <span class="nd">@scopeproperty</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">fspath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; the file system path of the test module which collected this test. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">fspath</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; keywords/markers dictionary for the underlying node. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">keywords</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; pytest session object. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">session</span>

<div class="viewcode-block" id="FixtureRequest.addfinalizer"><a class="viewcode-back" href="../../reference.html#pytest.FixtureRequest.addfinalizer">[docs]</a>    <span class="k">def</span> <span class="nf">addfinalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finalizer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; add finalizer/teardown function to be called after the</span>
<span class="sd">        last test within the requesting test context finished</span>
<span class="sd">        execution. &quot;&quot;&quot;</span>
        <span class="c1"># XXX usually this method is shadowed by fixturedef specific ones</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addfinalizer</span><span class="p">(</span><span class="n">finalizer</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_addfinalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finalizer</span><span class="p">,</span> <span class="n">scope</span><span class="p">):</span>
        <span class="n">colitem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getscopeitem</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_setupstate</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span>
            <span class="n">finalizer</span><span class="o">=</span><span class="n">finalizer</span><span class="p">,</span> <span class="n">colitem</span><span class="o">=</span><span class="n">colitem</span>
        <span class="p">)</span>

<div class="viewcode-block" id="FixtureRequest.applymarker"><a class="viewcode-back" href="../../reference.html#pytest.FixtureRequest.applymarker">[docs]</a>    <span class="k">def</span> <span class="nf">applymarker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">marker</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Apply a marker to a single test function invocation.</span>
<span class="sd">        This method is useful if you don&#39;t want to have a keyword/marker</span>
<span class="sd">        on all function invocations.</span>

<span class="sd">        :arg marker: a :py:class:`_pytest.mark.MarkDecorator` object</span>
<span class="sd">            created by a call to ``pytest.mark.NAME(...)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span></div>

<div class="viewcode-block" id="FixtureRequest.raiseerror"><a class="viewcode-back" href="../../reference.html#pytest.FixtureRequest.raiseerror">[docs]</a>    <span class="k">def</span> <span class="nf">raiseerror</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; raise a FixtureLookupError with the given message. &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">FixtureLookupError</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_fillfixtures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span>
        <span class="n">fixturenames</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;fixturenames&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">argname</span> <span class="ow">in</span> <span class="n">fixturenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">argname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">funcargs</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">funcargs</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getfixturevalue</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span>

<div class="viewcode-block" id="FixtureRequest.cached_setup"><a class="viewcode-back" href="../../reference.html#pytest.FixtureRequest.cached_setup">[docs]</a>    <span class="k">def</span> <span class="nf">cached_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="n">teardown</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">,</span> <span class="n">extrakey</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; (deprecated) Return a testing resource managed by ``setup`` &amp;</span>
<span class="sd">        ``teardown`` calls.  ``scope`` and ``extrakey`` determine when the</span>
<span class="sd">        ``teardown`` function will be called so that subsequent calls to</span>
<span class="sd">        ``setup`` would recreate the resource.  With pytest-2.3 you often</span>
<span class="sd">        do not need ``cached_setup()`` as you can directly declare a scope</span>
<span class="sd">        on a fixture function and register a finalizer through</span>
<span class="sd">        ``request.addfinalizer()``.</span>

<span class="sd">        :arg teardown: function receiving a previously setup resource.</span>
<span class="sd">        :arg setup: a no-argument function creating a resource.</span>
<span class="sd">        :arg scope: a string value out of ``function``, ``class``, ``module``</span>
<span class="sd">            or ``session`` indicating the caching lifecycle of the resource.</span>
<span class="sd">        :arg extrakey: added to internal caching key of (funcargname, scope).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">_pytest.deprecated</span> <span class="kn">import</span> <span class="n">CACHED_SETUP</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">CACHED_SETUP</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;_setupcache&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_setupcache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># XXX weakref?</span>
        <span class="n">cachekey</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixturename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getscopeitem</span><span class="p">(</span><span class="n">scope</span><span class="p">),</span> <span class="n">extrakey</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_setupcache</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">cachekey</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_scope</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixturename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">setup</span><span class="p">()</span>
            <span class="n">cache</span><span class="p">[</span><span class="n">cachekey</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="n">teardown</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">finalizer</span><span class="p">():</span>
                    <span class="k">del</span> <span class="n">cache</span><span class="p">[</span><span class="n">cachekey</span><span class="p">]</span>
                    <span class="n">teardown</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_addfinalizer</span><span class="p">(</span><span class="n">finalizer</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span></div>

<div class="viewcode-block" id="FixtureRequest.getfixturevalue"><a class="viewcode-back" href="../../reference.html#pytest.FixtureRequest.getfixturevalue">[docs]</a>    <span class="k">def</span> <span class="nf">getfixturevalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Dynamically run a named fixture function.</span>

<span class="sd">        Declaring fixtures via function argument is recommended where possible.</span>
<span class="sd">        But if you can only decide whether to use another fixture at test</span>
<span class="sd">        setup time, you may use this function to retrieve it inside a fixture</span>
<span class="sd">        or test function body.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_active_fixturedef</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span><span class="o">.</span><span class="n">cached_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="FixtureRequest.getfuncargvalue"><a class="viewcode-back" href="../../reference.html#pytest.FixtureRequest.getfuncargvalue">[docs]</a>    <span class="k">def</span> <span class="nf">getfuncargvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deprecated, use getfixturevalue. &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">_pytest</span> <span class="kn">import</span> <span class="n">deprecated</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">deprecated</span><span class="o">.</span><span class="n">GETFUNCARGVALUE</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getfixturevalue</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_active_fixturedef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argname</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixture_defs</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fixturedef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getnextfixturedef</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FixtureLookupError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">argname</span> <span class="o">==</span> <span class="s2">&quot;request&quot;</span><span class="p">:</span>
                    <span class="n">cached_result</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">scope</span> <span class="o">=</span> <span class="s2">&quot;function&quot;</span>
                    <span class="k">return</span> <span class="n">PseudoFixtureDef</span><span class="p">(</span><span class="n">cached_result</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="c1"># remove indent to prevent the python3 exception</span>
        <span class="c1"># from leaking into the call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_fixture_value</span><span class="p">(</span><span class="n">fixturedef</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixture_defs</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixturedef</span>
        <span class="k">return</span> <span class="n">fixturedef</span>

    <span class="k">def</span> <span class="nf">_get_fixturestack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fixturedef</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s2">&quot;_fixturedef&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fixturedef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">values</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fixturedef</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">_parent_request</span>

    <span class="k">def</span> <span class="nf">_compute_fixture_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fixturedef</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a SubRequest based on &quot;self&quot; and calls the execute method of the given fixturedef object. This will</span>
<span class="sd">        force the FixtureDef object to throw away any previous results and compute a new fixture value, which</span>
<span class="sd">        will be stored into the FixtureDef object itself.</span>

<span class="sd">        :param FixtureDef fixturedef:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># prepare a subrequest object before calling fixture function</span>
        <span class="c1"># (latter managed by fixturedef)</span>
        <span class="n">argname</span> <span class="o">=</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">argname</span>
        <span class="n">funcitem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">scope</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">funcitem</span><span class="o">.</span><span class="n">callspec</span><span class="o">.</span><span class="n">getparam</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">NOTSET</span>
            <span class="n">param_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">has_params</span> <span class="o">=</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">fixtures_not_supported</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">funcitem</span><span class="p">,</span> <span class="s2">&quot;nofuncargs&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_params</span> <span class="ow">and</span> <span class="n">fixtures_not_supported</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{name}</span><span class="s2"> does not support fixtures, maybe unittest.TestCase subclass?</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Node id: </span><span class="si">{nodeid}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Function type: </span><span class="si">{typename}</span><span class="s2">&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">funcitem</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">nodeid</span><span class="o">=</span><span class="n">funcitem</span><span class="o">.</span><span class="n">nodeid</span><span class="p">,</span>
                    <span class="n">typename</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">funcitem</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">fail</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_params</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">frameinfo</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">source_path</span> <span class="o">=</span> <span class="n">frameinfo</span><span class="o">.</span><span class="n">filename</span>
                <span class="n">source_lineno</span> <span class="o">=</span> <span class="n">frameinfo</span><span class="o">.</span><span class="n">lineno</span>
                <span class="n">source_path</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">source_path</span><span class="o">.</span><span class="n">relto</span><span class="p">(</span><span class="n">funcitem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rootdir</span><span class="p">):</span>
                    <span class="n">source_path</span> <span class="o">=</span> <span class="n">source_path</span><span class="o">.</span><span class="n">relto</span><span class="p">(</span><span class="n">funcitem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rootdir</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;The requested fixture has no parameter defined for test:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;    </span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Requested fixture &#39;</span><span class="si">{}</span><span class="s2">&#39; defined in:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Requested here:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">funcitem</span><span class="o">.</span><span class="n">nodeid</span><span class="p">,</span>
                        <span class="n">fixturedef</span><span class="o">.</span><span class="n">argname</span><span class="p">,</span>
                        <span class="n">getlocation</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">funcitem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rootdir</span><span class="p">),</span>
                        <span class="n">source_path</span><span class="p">,</span>
                        <span class="n">source_lineno</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">fail</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># indices might not be set if old-style metafunc.addcall() was used</span>
            <span class="n">param_index</span> <span class="o">=</span> <span class="n">funcitem</span><span class="o">.</span><span class="n">callspec</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># if a parametrize invocation set a scope it will override</span>
            <span class="c1"># the static scope defined with the fixture function</span>
            <span class="n">paramscopenum</span> <span class="o">=</span> <span class="n">funcitem</span><span class="o">.</span><span class="n">callspec</span><span class="o">.</span><span class="n">_arg2scopenum</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">paramscopenum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">scopes</span><span class="p">[</span><span class="n">paramscopenum</span><span class="p">]</span>

        <span class="n">subrequest</span> <span class="o">=</span> <span class="n">SubRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_index</span><span class="p">,</span> <span class="n">fixturedef</span><span class="p">)</span>

        <span class="c1"># check if a higher-level scoped fixture accesses a lower level one</span>
        <span class="n">subrequest</span><span class="o">.</span><span class="n">_check_scope</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>

        <span class="c1"># clear sys.exc_info before invoking the fixture (python bug?)</span>
        <span class="c1"># if it&#39;s not explicitly cleared it will leak into the call</span>
        <span class="n">exc_clear</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># call the fixture function</span>
            <span class="n">fixturedef</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">subrequest</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># if fixture function failed it might have registered finalizers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_setupstate</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span>
                <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">finish</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">subrequest</span><span class="p">),</span>
                <span class="n">subrequest</span><span class="o">.</span><span class="n">node</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">invoking_scope</span><span class="p">,</span> <span class="n">requested_scope</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">argname</span> <span class="o">==</span> <span class="s2">&quot;request&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">scopemismatch</span><span class="p">(</span><span class="n">invoking_scope</span><span class="p">,</span> <span class="n">requested_scope</span><span class="p">):</span>
            <span class="c1"># try to report something helpful</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factorytraceback</span><span class="p">()</span>
            <span class="n">fail</span><span class="p">(</span>
                <span class="s2">&quot;ScopeMismatch: You tried to access the </span><span class="si">%r</span><span class="s2"> scoped &quot;</span>
                <span class="s2">&quot;fixture </span><span class="si">%r</span><span class="s2"> with a </span><span class="si">%r</span><span class="s2"> scoped request object, &quot;</span>
                <span class="s2">&quot;involved factories</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">((</span><span class="n">requested_scope</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">invoking_scope</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))),</span>
                <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_factorytraceback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fixturedef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fixturestack</span><span class="p">():</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span>
            <span class="n">fs</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">getfslineno</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">fspath</span><span class="o">.</span><span class="n">bestrelpath</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">_format_args</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%d</span><span class="s2">:  def </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">factory</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="nf">_getscopeitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">:</span>
            <span class="c1"># this might also be a non-function Item despite its attribute name</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span>
        <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;package&quot;</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">get_scope_package</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixturedef</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">get_scope_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;class&quot;</span><span class="p">:</span>
            <span class="c1"># fallback to function item itself</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span>
        <span class="k">assert</span> <span class="n">node</span><span class="p">,</span> <span class="s1">&#39;Could not obtain a node for scope &quot;</span><span class="si">{}</span><span class="s1">&quot; for function </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">scope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;FixtureRequest for </span><span class="si">%r</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">SubRequest</span><span class="p">(</span><span class="n">FixtureRequest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a sub request for handling getting a fixture from a</span>
<span class="sd">    test function/fixture. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_index</span><span class="p">,</span> <span class="n">fixturedef</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixturename</span> <span class="o">=</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">argname</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTSET</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_index</span> <span class="o">=</span> <span class="n">param_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixturedef</span> <span class="o">=</span> <span class="n">fixturedef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">_pyfuncitem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixture_defs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">_fixture_defs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">_arg2fixturedefs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg2index</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">_arg2index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixturemanager</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">_fixturemanager</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;SubRequest </span><span class="si">%r</span><span class="s2"> for </span><span class="si">%r</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixturename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addfinalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finalizer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixturedef</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">finalizer</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ScopeMismatchError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A fixture function tries to use a different fixture function which</span>
<span class="sd">    which has a lower scope (e.g. a Session one calls a function one)</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="n">scopes</span> <span class="o">=</span> <span class="s2">&quot;session package module class function&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">scopenum_function</span> <span class="o">=</span> <span class="n">scopes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">scopemismatch</span><span class="p">(</span><span class="n">currentscope</span><span class="p">,</span> <span class="n">newscope</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">scopes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">newscope</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">scopes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">currentscope</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">scope2index</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">descr</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look up the index of ``scope`` and raise a descriptive value error</span>
<span class="sd">    if not defined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">scopes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">got an unexpected scope value &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">descr</span><span class="p">,</span> <span class="s2">&quot;from </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">where</span><span class="p">)</span> <span class="k">if</span> <span class="n">where</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">scope</span>
            <span class="p">),</span>
            <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">FixtureLookupError</span><span class="p">(</span><span class="ne">LookupError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; could not return a requested Fixture (missing or invalid). &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argname</span> <span class="o">=</span> <span class="n">argname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixturestack</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">_get_fixturestack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">formatrepr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tblines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">addline</span> <span class="o">=</span> <span class="n">tblines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">obj</span><span class="p">]</span>
        <span class="n">stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixturestack</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># the last fixture raise an error, let&#39;s present</span>
            <span class="c1"># it at the requesting side</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">fspath</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">getfslineno</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lines</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">get_real_func</span><span class="p">(</span><span class="n">function</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;file </span><span class="si">%s</span><span class="s2">, line </span><span class="si">%s</span><span class="s2">: source code not available&quot;</span>
                <span class="n">addline</span><span class="p">(</span><span class="n">error_msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">fspath</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">addline</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">%s</span><span class="s2">, line </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fspath</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                    <span class="n">addline</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;def&quot;</span><span class="p">):</span>
                        <span class="k">break</span>

        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_fixturemanager</span>
            <span class="n">available</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">parentid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_pyfuncitem</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">nodeid</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fixturedefs</span> <span class="ow">in</span> <span class="n">fm</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">faclist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">_matchfactories</span><span class="p">(</span><span class="n">fixturedefs</span><span class="p">,</span> <span class="n">parentid</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">faclist</span><span class="p">:</span>
                    <span class="n">available</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argname</span> <span class="ow">in</span> <span class="n">available</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot; recursive dependency involving fixture &#39;</span><span class="si">{}</span><span class="s2">&#39; detected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">argname</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;fixture &#39;</span><span class="si">{}</span><span class="s2">&#39; not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argname</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> available fixtures: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">available</span><span class="p">)))</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> use &#39;pytest --fixtures [testpath]&#39; for help on them.&quot;</span>

        <span class="k">return</span> <span class="n">FixtureLookupErrorRepr</span><span class="p">(</span><span class="n">fspath</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">tblines</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">argname</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FixtureLookupErrorRepr</span><span class="p">(</span><span class="n">TerminalRepr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">firstlineno</span><span class="p">,</span> <span class="n">tblines</span><span class="p">,</span> <span class="n">errorstring</span><span class="p">,</span> <span class="n">argname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tblines</span> <span class="o">=</span> <span class="n">tblines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errorstring</span> <span class="o">=</span> <span class="n">errorstring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">firstlineno</span> <span class="o">=</span> <span class="n">firstlineno</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argname</span> <span class="o">=</span> <span class="n">argname</span>

    <span class="k">def</span> <span class="nf">toterminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tw</span><span class="p">):</span>
        <span class="c1"># tw.line(&quot;FixtureLookupError: %s&quot; %(self.argname), red=True)</span>
        <span class="k">for</span> <span class="n">tbline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tblines</span><span class="p">:</span>
            <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">tbline</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">       </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FormattedExcinfo</span><span class="o">.</span><span class="n">fail_marker</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
                <span class="n">red</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">       </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FormattedExcinfo</span><span class="o">.</span><span class="n">flow_marker</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
                    <span class="n">red</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">()</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstlineno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">fail_fixturefunc</span><span class="p">(</span><span class="n">fixturefunc</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="n">fs</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">getfslineno</span><span class="p">(</span><span class="n">fixturefunc</span><span class="p">)</span>
    <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">_code</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">fixturefunc</span><span class="p">)</span>
    <span class="n">fail</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;:</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">indent</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">location</span><span class="p">,</span> <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">call_fixture_func</span><span class="p">(</span><span class="n">fixturefunc</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="n">yieldctx</span> <span class="o">=</span> <span class="n">is_generator</span><span class="p">(</span><span class="n">fixturefunc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yieldctx</span><span class="p">:</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">fixturefunc</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="n">finalizer</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_teardown_yield_fixture</span><span class="p">,</span> <span class="n">fixturefunc</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">finalizer</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fixturefunc</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">_teardown_yield_fixture</span><span class="p">(</span><span class="n">fixturefunc</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Executes the teardown of a fixture function by advancing the iterator after the</span>
<span class="sd">    yield and ensure the iteration ends (if not it means there is more than one yield in the function)&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fail_fixturefunc</span><span class="p">(</span>
            <span class="n">fixturefunc</span><span class="p">,</span> <span class="s2">&quot;yield_fixture function has more than one &#39;yield&#39;&quot;</span>
        <span class="p">)</span>


<div class="viewcode-block" id="FixtureDef"><a class="viewcode-back" href="../../reference.html#pytest.FixtureDef">[docs]</a><span class="k">class</span> <span class="nc">FixtureDef</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A container for a factory definition. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fixturemanager</span><span class="p">,</span>
        <span class="n">baseid</span><span class="p">,</span>
        <span class="n">argname</span><span class="p">,</span>
        <span class="n">func</span><span class="p">,</span>
        <span class="n">scope</span><span class="p">,</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">unittest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixturemanager</span> <span class="o">=</span> <span class="n">fixturemanager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseid</span> <span class="o">=</span> <span class="n">baseid</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_location</span> <span class="o">=</span> <span class="n">baseid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argname</span> <span class="o">=</span> <span class="n">argname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scopenum</span> <span class="o">=</span> <span class="n">scope2index</span><span class="p">(</span>
            <span class="n">scope</span> <span class="ow">or</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
            <span class="n">descr</span><span class="o">=</span><span class="s2">&quot;Fixture &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
            <span class="n">where</span><span class="o">=</span><span class="n">baseid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argnames</span> <span class="o">=</span> <span class="n">getfuncargnames</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">is_method</span><span class="o">=</span><span class="n">unittest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unittest</span> <span class="o">=</span> <span class="n">unittest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalizers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">addfinalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finalizer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalizers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">finalizer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalizers</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalizers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">func</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa</span>
                    <span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">exceptions</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">exceptions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">exceptions</span>  <span class="c1"># ensure we don&#39;t keep all frames alive because of the traceback</span>
                <span class="n">six</span><span class="o">.</span><span class="n">reraise</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">gethookproxy</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">fspath</span><span class="p">)</span>
            <span class="n">hook</span><span class="o">.</span><span class="n">pytest_fixture_post_finalizer</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
            <span class="c1"># even if finalization fails, we invalidate</span>
            <span class="c1"># the cached fixture value and remove</span>
            <span class="c1"># all finalizers because they may be bound methods which will</span>
            <span class="c1"># keep instances alive</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cached_result&quot;</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finalizers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># get required arguments and register our own finish()</span>
        <span class="c1"># with their finalization</span>
        <span class="k">for</span> <span class="n">argname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">argnames</span><span class="p">:</span>
            <span class="n">fixturedef</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">_get_active_fixturedef</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">argname</span> <span class="o">!=</span> <span class="s2">&quot;request&quot;</span><span class="p">:</span>
                <span class="n">fixturedef</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">))</span>

        <span class="n">my_cache_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">param_index</span>
        <span class="n">cached_result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cached_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cached_result</span>
            <span class="k">if</span> <span class="n">my_cache_key</span> <span class="o">==</span> <span class="n">cache_key</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">six</span><span class="o">.</span><span class="n">reraise</span><span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">result</span>
            <span class="c1"># we have a previous but differently parametrized fixture instance</span>
            <span class="c1"># so we need to tear it down before creating a new one</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cached_result&quot;</span><span class="p">)</span>

        <span class="n">hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">gethookproxy</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">fspath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hook</span><span class="o">.</span><span class="n">pytest_fixture_setup</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;FixtureDef argname=</span><span class="si">%r</span><span class="s2"> scope=</span><span class="si">%r</span><span class="s2"> baseid=</span><span class="si">%r</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">argname</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baseid</span><span class="p">,</span>
        <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">resolve_fixture_function</span><span class="p">(</span><span class="n">fixturedef</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the actual callable that can be called to obtain the fixture value, dealing with unittest-specific</span>
<span class="sd">    instances and bound methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fixturefunc</span> <span class="o">=</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span>
    <span class="k">if</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">unittest</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># bind the unbound method to the TestCase instance</span>
            <span class="n">fixturefunc</span> <span class="o">=</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># the fixture function needs to be bound to the actual</span>
        <span class="c1"># request.instance so that code working with &quot;fixturedef&quot; behaves</span>
        <span class="c1"># as expected.</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fixturefunc</span> <span class="o">=</span> <span class="n">getimfunc</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fixturefunc</span> <span class="o">!=</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span><span class="p">:</span>
                <span class="n">fixturefunc</span> <span class="o">=</span> <span class="n">fixturefunc</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fixturefunc</span>


<span class="k">def</span> <span class="nf">pytest_fixture_setup</span><span class="p">(</span><span class="n">fixturedef</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Execution of fixture setup. &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">argname</span> <span class="ow">in</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">argnames</span><span class="p">:</span>
        <span class="n">fixdef</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">_get_active_fixturedef</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">arg_cache_key</span><span class="p">,</span> <span class="n">exc</span> <span class="o">=</span> <span class="n">fixdef</span><span class="o">.</span><span class="n">cached_result</span>
        <span class="n">request</span><span class="o">.</span><span class="n">_check_scope</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">fixdef</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

    <span class="n">fixturefunc</span> <span class="o">=</span> <span class="n">resolve_fixture_function</span><span class="p">(</span><span class="n">fixturedef</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">my_cache_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">param_index</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">call_fixture_func</span><span class="p">(</span><span class="n">fixturefunc</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">TEST_OUTCOME</span><span class="p">:</span>
        <span class="n">fixturedef</span><span class="o">.</span><span class="n">cached_result</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">my_cache_key</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="k">raise</span>
    <span class="n">fixturedef</span><span class="o">.</span><span class="n">cached_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">my_cache_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_ensure_immutable_ids</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ids</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">wrap_function_to_warning_if_called_directly</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">fixture_marker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrap the given fixture function so we can issue warnings about it being called directly, instead of</span>
<span class="sd">    used as an argument in a test function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_yield_function</span> <span class="o">=</span> <span class="n">is_generator</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="n">warning</span> <span class="o">=</span> <span class="n">FIXTURE_FUNCTION_CALL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">fixture_marker</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">is_yield_function</span><span class="p">:</span>

        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">__tracebackhide__</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">x</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">__tracebackhide__</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY2</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">__wrapped__</span> <span class="o">=</span> <span class="n">function</span>

    <span class="c1"># keep reference to the original function in our own custom attribute so we don&#39;t unwrap</span>
    <span class="c1"># further than this point and lose useful wrappings like @mock.patch (#3774)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">__pytest_wrapped__</span> <span class="o">=</span> <span class="n">_PytestWrapper</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">FixtureFunctionMarker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">converter</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="o">.</span><span class="n">optional</span><span class="p">(</span><span class="nb">tuple</span><span class="p">))</span>
    <span class="n">autouse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="n">_ensure_immutable_ids</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">isclass</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;class fixtures not supported (maybe in the future)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="s2">&quot;_pytestfixturefunction&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;fixture is being applied more than once to the same function&quot;</span>
            <span class="p">)</span>

        <span class="n">function</span> <span class="o">=</span> <span class="n">wrap_function_to_warning_if_called_directly</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;request&quot;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">FIXTURE_NAMED_REQUEST</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">_pytestfixturefunction</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">function</span>


<div class="viewcode-block" id="fixture"><a class="viewcode-back" href="../../reference.html#pytest.fixture">[docs]</a><span class="k">def</span> <span class="nf">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to mark a fixture factory function.</span>

<span class="sd">    This decorator can be used, with or without parameters, to define a</span>
<span class="sd">    fixture function.</span>

<span class="sd">    The name of the fixture function can later be referenced to cause its</span>
<span class="sd">    invocation ahead of running tests: test</span>
<span class="sd">    modules or classes can use the ``pytest.mark.usefixtures(fixturename)``</span>
<span class="sd">    marker.</span>

<span class="sd">    Test functions can directly use fixture names as input</span>
<span class="sd">    arguments in which case the fixture instance returned from the fixture</span>
<span class="sd">    function will be injected.</span>

<span class="sd">    Fixtures can provide their values to test functions using ``return`` or ``yield``</span>
<span class="sd">    statements. When using ``yield`` the code block after the ``yield`` statement is executed</span>
<span class="sd">    as teardown code regardless of the test outcome, and must yield exactly once.</span>

<span class="sd">    :arg scope: the scope for which this fixture is shared, one of</span>
<span class="sd">                ``&quot;function&quot;`` (default), ``&quot;class&quot;``, ``&quot;module&quot;``,</span>
<span class="sd">                ``&quot;package&quot;`` or ``&quot;session&quot;``.</span>

<span class="sd">                ``&quot;package&quot;`` is considered **experimental** at this time.</span>

<span class="sd">    :arg params: an optional list of parameters which will cause multiple</span>
<span class="sd">                invocations of the fixture function and all of the tests</span>
<span class="sd">                using it.</span>

<span class="sd">    :arg autouse: if True, the fixture func is activated for all tests that</span>
<span class="sd">                can see it.  If False (the default) then an explicit</span>
<span class="sd">                reference is needed to activate the fixture.</span>

<span class="sd">    :arg ids: list of string ids each corresponding to the params</span>
<span class="sd">                so that they are part of the test id. If no ids are provided</span>
<span class="sd">                they will be generated automatically from the params.</span>

<span class="sd">    :arg name: the name of the fixture. This defaults to the name of the</span>
<span class="sd">                decorated function. If a fixture is used in the same module in</span>
<span class="sd">                which it is defined, the function name of the fixture will be</span>
<span class="sd">                shadowed by the function arg that requests the fixture; one way</span>
<span class="sd">                to resolve this is to name the decorated function</span>
<span class="sd">                ``fixture_&lt;fixturename&gt;`` and then use</span>
<span class="sd">                ``@pytest.fixture(name=&#39;&lt;fixturename&gt;&#39;)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="ow">and</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">autouse</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># direct decoration</span>
        <span class="k">return</span> <span class="n">FixtureFunctionMarker</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">autouse</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)(</span><span class="n">scope</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">FixtureFunctionMarker</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">autouse</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">yield_fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; (return a) decorator to mark a yield-fixture factory function.</span>

<span class="sd">    .. deprecated:: 3.0</span>
<span class="sd">        Use :py:func:`pytest.fixture` directly instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="n">autouse</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>


<span class="n">defaultfuncargprefixmarker</span> <span class="o">=</span> <span class="n">fixture</span><span class="p">()</span>


<div class="viewcode-block" id="pytestconfig"><a class="viewcode-back" href="../../reference.html#pytest.pytestconfig">[docs]</a><span class="nd">@fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytestconfig</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Session-scoped fixture that returns the :class:`_pytest.config.Config` object.</span>

<span class="sd">    Example::</span>

<span class="sd">        def test_foo(pytestconfig):</span>
<span class="sd">            if pytestconfig.getoption(&quot;verbose&quot;):</span>
<span class="sd">                ...</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span></div>


<span class="k">class</span> <span class="nc">FixtureManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    pytest fixtures definitions and information is stored and managed</span>
<span class="sd">    from this class.</span>

<span class="sd">    During collection fm.parsefactories() is called multiple times to parse</span>
<span class="sd">    fixture function definitions into FixtureDef objects and internal</span>
<span class="sd">    data structures.</span>

<span class="sd">    During collection of test functions, metafunc-mechanics instantiate</span>
<span class="sd">    a FuncFixtureInfo object which is cached per node/func-name.</span>
<span class="sd">    This FuncFixtureInfo object is later retrieved by Function nodes</span>
<span class="sd">    which themselves offer a fixturenames attribute.</span>

<span class="sd">    The FuncFixtureInfo object holds information about fixtures and FixtureDefs</span>
<span class="sd">    relevant for a particular function.  An initial list of fixtures is</span>
<span class="sd">    assembled like this:</span>

<span class="sd">    - ini-defined usefixtures</span>
<span class="sd">    - autouse-marked fixtures along the collection chain up from the function</span>
<span class="sd">    - usefixtures markers at module/class/function level</span>
<span class="sd">    - test function funcargs</span>

<span class="sd">    Subsequently the funcfixtureinfo.fixturenames attribute is computed</span>
<span class="sd">    as the closure of the fixtures needed to setup the initial fixtures,</span>
<span class="sd">    i. e. fixtures needed by fixture functions themselves are appended</span>
<span class="sd">    to the fixturenames list.</span>

<span class="sd">    Upon the test-setup phases all fixturenames are instantiated, retrieved</span>
<span class="sd">    by a lookup of their FuncFixtureInfo.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_argprefix</span> <span class="o">=</span> <span class="s2">&quot;pytest_funcarg__&quot;</span>
    <span class="n">FixtureLookupError</span> <span class="o">=</span> <span class="n">FixtureLookupError</span>
    <span class="n">FixtureLookupErrorRepr</span> <span class="o">=</span> <span class="n">FixtureLookupErrorRepr</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_holderobjseen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg2finish</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodeid_and_autousenames</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="s2">&quot;usefixtures&quot;</span><span class="p">))]</span>
        <span class="n">session</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;funcmanage&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getfixtureinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">funcargs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">funcargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;nofuncargs&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">argnames</span> <span class="o">=</span> <span class="n">getfuncargnames</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">argnames</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">usefixtures</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span>
            <span class="n">mark</span><span class="o">.</span><span class="n">args</span> <span class="k">for</span> <span class="n">mark</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iter_markers</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;usefixtures&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">initialnames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">usefixtures</span><span class="p">)</span> <span class="o">+</span> <span class="n">argnames</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span>
        <span class="n">initialnames</span><span class="p">,</span> <span class="n">names_closure</span><span class="p">,</span> <span class="n">arg2fixturedefs</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getfixtureclosure</span><span class="p">(</span>
            <span class="n">initialnames</span><span class="p">,</span> <span class="n">node</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">FuncFixtureInfo</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">initialnames</span><span class="p">,</span> <span class="n">names_closure</span><span class="p">,</span> <span class="n">arg2fixturedefs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pytest_plugin_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugin</span><span class="p">):</span>
        <span class="n">nodeid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">plugin</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">realpath</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># construct the base nodeid which is later used to check</span>
            <span class="c1"># what fixtures are visible for particular tests (as denoted</span>
            <span class="c1"># by their test id)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">basename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;conftest.py&quot;</span><span class="p">):</span>
                <span class="n">nodeid</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">dirpath</span><span class="p">()</span><span class="o">.</span><span class="n">relto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rootdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">sep</span> <span class="o">!=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SEP</span><span class="p">:</span>
                    <span class="n">nodeid</span> <span class="o">=</span> <span class="n">nodeid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SEP</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parsefactories</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getautousenames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return a tuple of fixture names to be used. &quot;&quot;&quot;</span>
        <span class="n">autousenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">baseid</span><span class="p">,</span> <span class="n">basenames</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodeid_and_autousenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nodeid</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">baseid</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">baseid</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">baseid</span><span class="p">)</span>
                    <span class="n">nextchar</span> <span class="o">=</span> <span class="n">nodeid</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">nextchar</span> <span class="ow">and</span> <span class="n">nextchar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;:/&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">autousenames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">basenames</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">autousenames</span>

    <span class="k">def</span> <span class="nf">getfixtureclosure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fixturenames</span><span class="p">,</span> <span class="n">parentnode</span><span class="p">):</span>
        <span class="c1"># collect the closure of all fixtures , starting with the given</span>
        <span class="c1"># fixturenames as the initial set.  As we have to visit all</span>
        <span class="c1"># factory definitions anyway, we also return an arg2fixturedefs</span>
        <span class="c1"># mapping so that the caller can reuse it and does not have</span>
        <span class="c1"># to re-discover fixturedefs again for each fixturename</span>
        <span class="c1"># (discovering matching fixtures for a given name/node is expensive)</span>

        <span class="n">parentid</span> <span class="o">=</span> <span class="n">parentnode</span><span class="o">.</span><span class="n">nodeid</span>
        <span class="n">fixturenames_closure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getautousenames</span><span class="p">(</span><span class="n">parentid</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">otherlist</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">otherlist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fixturenames_closure</span><span class="p">:</span>
                    <span class="n">fixturenames_closure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

        <span class="n">merge</span><span class="p">(</span><span class="n">fixturenames</span><span class="p">)</span>

        <span class="c1"># at this point, fixturenames_closure contains what we call &quot;initialnames&quot;,</span>
        <span class="c1"># which is a set of fixturenames the function immediately requests. We</span>
        <span class="c1"># need to return it as well, so save this.</span>
        <span class="n">initialnames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fixturenames_closure</span><span class="p">)</span>

        <span class="n">arg2fixturedefs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lastlen</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="n">lastlen</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixturenames_closure</span><span class="p">):</span>
            <span class="n">lastlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixturenames_closure</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">argname</span> <span class="ow">in</span> <span class="n">fixturenames_closure</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">argname</span> <span class="ow">in</span> <span class="n">arg2fixturedefs</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">fixturedefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getfixturedefs</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">parentid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fixturedefs</span><span class="p">:</span>
                    <span class="n">arg2fixturedefs</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixturedefs</span>
                    <span class="n">merge</span><span class="p">(</span><span class="n">fixturedefs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argnames</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">sort_by_scope</span><span class="p">(</span><span class="n">arg_name</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fixturedefs</span> <span class="o">=</span> <span class="n">arg2fixturedefs</span><span class="p">[</span><span class="n">arg_name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">scopes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fixturedefs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scopenum</span>

        <span class="n">fixturenames_closure</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">sort_by_scope</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">initialnames</span><span class="p">,</span> <span class="n">fixturenames_closure</span><span class="p">,</span> <span class="n">arg2fixturedefs</span>

    <span class="k">def</span> <span class="nf">pytest_generate_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metafunc</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">argname</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">:</span>
            <span class="n">faclist</span> <span class="o">=</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">faclist</span><span class="p">:</span>
                <span class="n">fixturedef</span> <span class="o">=</span> <span class="n">faclist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">parametrize_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metafunc</span><span class="o">.</span><span class="n">function</span><span class="p">,</span> <span class="s2">&quot;parametrize&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">parametrize_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">parametrize_func</span> <span class="o">=</span> <span class="n">parametrize_func</span><span class="o">.</span><span class="n">combined</span>
                    <span class="n">func_params</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parametrize_func</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[[</span><span class="kc">None</span><span class="p">]])</span>
                    <span class="n">func_kwargs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parametrize_func</span><span class="p">,</span> <span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="c1"># skip directly parametrized arguments</span>
                    <span class="k">if</span> <span class="s2">&quot;argnames&quot;</span> <span class="ow">in</span> <span class="n">func_kwargs</span><span class="p">:</span>
                        <span class="n">argnames</span> <span class="o">=</span> <span class="n">parametrize_func</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;argnames&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">argnames</span> <span class="o">=</span> <span class="n">func_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                        <span class="n">argnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">argnames</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="n">argname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">func_params</span> <span class="ow">and</span> <span class="n">argname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">:</span>
                        <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
                            <span class="n">argname</span><span class="p">,</span>
                            <span class="n">fixturedef</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                            <span class="n">indirect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">scope</span><span class="o">=</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span>
                            <span class="n">ids</span><span class="o">=</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># will raise FixtureLookupError at setup time</span>

    <span class="k">def</span> <span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="c1"># separate parametrized setups</span>
        <span class="n">items</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">reorder_items</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parsefactories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_or_obj</span><span class="p">,</span> <span class="n">nodeid</span><span class="o">=</span><span class="n">NOTSET</span><span class="p">,</span> <span class="n">unittest</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">_pytest</span> <span class="kn">import</span> <span class="n">deprecated</span>

        <span class="k">if</span> <span class="n">nodeid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTSET</span><span class="p">:</span>
            <span class="n">holderobj</span> <span class="o">=</span> <span class="n">node_or_obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">holderobj</span> <span class="o">=</span> <span class="n">node_or_obj</span><span class="o">.</span><span class="n">obj</span>
            <span class="n">nodeid</span> <span class="o">=</span> <span class="n">node_or_obj</span><span class="o">.</span><span class="n">nodeid</span>
        <span class="k">if</span> <span class="n">holderobj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_holderobjseen</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="kn">from</span> <span class="nn">_pytest.nodes</span> <span class="kn">import</span> <span class="n">_CompatProperty</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_holderobjseen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">holderobj</span><span class="p">)</span>
        <span class="n">autousenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">holderobj</span><span class="p">):</span>
            <span class="c1"># The attribute can be an arbitrary descriptor, so the attribute</span>
            <span class="c1"># access below can raise. safe_getatt() ignores such exceptions.</span>
            <span class="n">maybe_property</span> <span class="o">=</span> <span class="n">safe_getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">holderobj</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">maybe_property</span><span class="p">,</span> <span class="n">_CompatProperty</span><span class="p">):</span>
                <span class="c1"># deprecated</span>
                <span class="k">continue</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">safe_getattr</span><span class="p">(</span><span class="n">holderobj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="n">getfixturemarker</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="c1"># fixture functions have a pytest_funcarg__ prefix (pre-2.3 style)</span>
            <span class="c1"># or are &quot;@pytest.fixture&quot; marked</span>
            <span class="k">if</span> <span class="n">marker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_argprefix</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="n">defaultfuncargprefixmarker</span>

                <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">getfslineno</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn_explicit</span><span class="p">(</span>
                    <span class="n">deprecated</span><span class="o">.</span><span class="n">FUNCARG_PREFIX</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">),</span>
                    <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                    <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_argprefix</span><span class="p">)</span> <span class="p">:]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">FixtureFunctionMarker</span><span class="p">):</span>
                <span class="c1"># magic globals  with __getattr__ might have got us a wrong</span>
                <span class="c1"># fixture attribute</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">marker</span><span class="o">.</span><span class="n">name</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_argprefix</span><span class="p">),</span> <span class="n">FIXTURE_MSG</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># during fixture definition we wrap the original fixture function</span>
            <span class="c1"># to issue a warning if called directly, so here we unwrap it in order to not emit the warning</span>
            <span class="c1"># when pytest itself calls the fixture function</span>
            <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY2</span> <span class="ow">and</span> <span class="n">unittest</span><span class="p">:</span>
                <span class="c1"># hack on Python 2 because of the unbound methods</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">get_real_func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">get_real_method</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">holderobj</span><span class="p">)</span>

            <span class="n">fixture_def</span> <span class="o">=</span> <span class="n">FixtureDef</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">nodeid</span><span class="p">,</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">obj</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                <span class="n">unittest</span><span class="o">=</span><span class="n">unittest</span><span class="p">,</span>
                <span class="n">ids</span><span class="o">=</span><span class="n">marker</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">faclist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">fixture_def</span><span class="o">.</span><span class="n">has_location</span><span class="p">:</span>
                <span class="n">faclist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fixture_def</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># fixturedefs with no location are at the front</span>
                <span class="c1"># so this inserts the current fixturedef after the</span>
                <span class="c1"># existing fixturedefs from external plugins but</span>
                <span class="c1"># before the fixturedefs provided in conftests.</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">faclist</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">has_location</span><span class="p">])</span>
                <span class="n">faclist</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fixture_def</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">autouse</span><span class="p">:</span>
                <span class="n">autousenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">autousenames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nodeid_and_autousenames</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nodeid</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">autousenames</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">getfixturedefs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a list of fixtures which are applicable to the given node id.</span>

<span class="sd">        :param str argname: name of the fixture to search for</span>
<span class="sd">        :param str nodeid: full node id of the requesting test.</span>
<span class="sd">        :return: list[FixtureDef]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fixturedefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_matchfactories</span><span class="p">(</span><span class="n">fixturedefs</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_matchfactories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fixturedefs</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fixturedef</span> <span class="ow">in</span> <span class="n">fixturedefs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nodes</span><span class="o">.</span><span class="n">ischildnode</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">baseid</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">fixturedef</span>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../../contents.html">pytest-3.10</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2015–2018 , holger krekel and pytest-dev team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-7597274-13']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>